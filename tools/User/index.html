<!DOCTYPE html>
<html>

<head>
	<title></title>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="../Css/bootstrap.css" />
	<link rel="stylesheet" type="text/css" href="../Css/bootstrap-responsive.css" />
	<link rel="stylesheet" type="text/css" href="../Css/style.css" />
	<script type="text/javascript" src="../Js/jquery.js"></script>
	<script type="text/javascript" src="../Js/jquery-ui.js"></script>
	<script type="text/javascript" src="../Js/bootstrap.js"></script>
	<script type="text/javascript" src="../Js/ckform.js"></script>
	<script type="text/javascript" src="../Js/common.js"></script>
	<script type="text/javascript" src="../Js/js/laydate.js"></script>
	<script type="text/javascript" src="../Js/ui.js"></script>
	<script type="text/javascript" src="../Js/ursl.js"></script>
	<style type="text/css">
		body {
			padding-bottom: 40px;
		}


		@media (max-width: 980px) {
			/* 启用浮动导航栏文字 */
			.navbar-text.pull-right {
				float: none;
				padding-left: 5px;
				padding-right: 5px;
			}
		}
		#addnew1 {
			margin-top: 10px;
		}
		#addnew1 img{
			margin: 0;
		}

		#test {
			width: 100%;
			height: 100%;
			background-color: #000;
			position: absolute;
			top: 0;
			left: 0;
			z-index: 2;
			opacity: 0.3;
			/*兼容IE8及以下版本浏览器*/
			filter: alpha(opacity=30);
			display: none;
		}

		#log_window {
			width: 800px;
			height: 500px;
			padding-bottom: 50px;
			background-color: white;
			margin: auto;
			position: absolute;
			z-index: 3;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			display: none;
			overflow-y: scroll;
			/*border: 2px solid #b1d6e8;*/
		}

		#user_info {
			width: 800px;
			height: 500px;
			padding-bottom: 50px;
			background-color: white;
			margin: auto;
			position: absolute;
			z-index: 3;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			display: none;
			overflow-y: scroll;
			/*border: 2px solid #b1d6e8;*/
		}
		#user_photo {
			width: 800px;
			height: 420px;
			background-color: white;
			margin: auto;
			position: absolute;
			z-index: 3;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			display: none;
			overflow-y: scroll;
			/*border: 2px solid #b1d6e8;*/
		}
		#user_edit{
			width: 800px;
			height: 600px;
			padding-bottom: 50px;
			background-color: white;
			margin: auto;
			position: absolute;
			z-index: 3;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			display: none;
			overflow-y: scroll;
			/*border: 2px solid #b1d6e8;*/
		}
		.theadColor th {
			background-color: #b1d6e8;
			/*color: #1976b0;*/
			font-weight: normal;
			text-align: center;
			height: 20px;
			line-height: 22px;
		}

		.theadColor th span {
			color: #1976b0;
		}

		#chaxun {
			margin-top: 10px;
		}

		#rolename {
			position: relative;
			margin-top: 19px;
		}

		.theadColor td,
		.tableleft {
			/*background-color: #b1d6e8;*/
			/*color: #1976b0;*/
			/*font-weight:normal;*/
		}

		.theadColor td,.tableleft  span {
			color:#000;
			font-weight: bold;
		}

		.tdPadding {
			padding-top: 18px;
		}

		#rolename {
			padding-right: 30px;
			background: url("../assets/img/fangdajing.png") no-repeat scroll right center transparent;
		}

		#test1 {
			width: 100%;
			height: 100%;
			background-color: #000;
			position: absolute;
			top: 0;
			left: 0;
			z-index: 2;
			opacity: 0.3;
			/*兼容IE8及以下版本浏览器*/
			filter: alpha(opacity=30);
			display: none;
		}
		.onclick{
			margin-left: 35px;
		}
		.onclick a{
			margin: 0;

		}
	</style>
	<script type="text/javascript">
        var subpath="User";
        var page = 1;
        var count = 10;
        var maxpage = 0;
        var dataarr = [];
        //所有角色
        var freerole=[];
        //所有拳馆
        var freevenue=[];
        var updateUser1=[];
        var currentIndex = -1;
        var localhost = " ";
        var table, role, res;
        var fields=[];
        var searchfileds=[];
        var filedtop=[];
        var filedbottom=[];
        var levels=[{"1":"一级馆长"},{"2":"二级馆长"},{"3":"三级馆长"}];
        var levels2=[{"1":"储备教练"},{"2":"中级教练"},{"3":"高级教练"},{"4":"总教练"}];
        var genders=[{"1":"男"},{"2":"女"}];
        var addable1,updateable1,delable1,authority,pms,enables;
        localhost = window.sessionStorage ? sessionStorage.getItem("lh") : Cookie.read("lh");

        var url1=urls;
        $(function() {
            $(document).tooltip();
        });
        //                function displayProp(obj){
        //                    var names="";
        //                    for(var name in obj){
        //                        names+=name+": "+obj[name]+", ";
        //                    }
        //                    alert(names);
        //                }
        //加载列表
        function init() {

            //localhost = window.sessionStorage ? sessionStorage.getItem("lh") : Cookie.read("lh");
            table = 1;
            var uname = window.sessionStorage ? sessionStorage.getItem("mgr") : Cookie.read("mgr");
            manager = jQuery.parseJSON(uname);
            mid = manager.mid;
            mgrid = manager.id;
            role = manager.type;

            pms = window.sessionStorage? sessionStorage.getItem("管 理 员"): Cookie.read("管 理 员");

            authority = jQuery.parseJSON(pms);
            addable1 = authority.addable;
            updateable1 = authority.updateable;
            delable1 = authority.delable;
            enables = authority.enable;
//                alert(authority)


            if (null == uname || undefined == uname) {
                parent.window.location = '../Public/login.html';
                return;
            }
            if (window.sessionStorage) {
                page = sessionStorage.getItem("Node_page");
            } else {
                page = Cookie.read("Node_page");
            }
            if (null == page)
                page = 1;
            document.getElementById('pagelab').value = page;

            //判断各浏览器的兼容性
            var Sys = {};
            var ua = navigator.userAgent.toLowerCase();
            var s;
            (s = ua.match(/msie ([\d.]+)/)) ? Sys.ie = s[1]:
                (s = ua.match(/firefox\/([\d.]+)/)) ? Sys.firefox = s[1] :
                    (s = ua.match(/chrome\/([\d.]+)/)) ? Sys.chrome = s[1] :
                        (s = ua.match(/opera.([\d.]+)/)) ? Sys.opera = s[1] :
                            (s = ua.match(/version\/([\d.]+).*safari/)) ? Sys.safari = s[1] : 0;
            if (Sys.ie) { //Js判断为IE浏览器
                alert('http://www.wangjinhai119.com' + Sys.ie);
                if (Sys.ie == '9.0') { //Js判断为IE 9
                } else if (Sys.ie == '8.0') { //Js判断为IE 8
                } else {}
            }
            if (Sys.firefox) { //Js判断为火狐(firefox)浏览器
                document.getElementById('pagelab').style.marginTop = '19px';
            }
            if (Sys.chrome) { //Js判断为谷歌chrome浏览器
                document.getElementById('pagelab').style.marginTop = '18px';
            }
            if (Sys.opera) { //Js判断为opera浏览器
                alert('http://www.wangjinhai119.com' + Sys.opera);
            }
            if (Sys.safari) { //Js判断为苹果safari浏览器
                document.getElementById('pagelab').style.marginTop = '9px';
            }
            initFields();
        }
        //动态表头
        function initFields() {
            $("#rolename").val(window.sessionStorage ? sessionStorage.getItem("rolename2") : Cookie.read("rolename2"));
            //alert(3333)
            //alert(url1)
            var users=new Object();
            users.rid=role;
            users.smid=4;
            var datajson=JSON.stringify(users);
            $.ajax({
                type: "post",
                contentType: "application/x-www-form-urlencoded",
                url: "http://" + url1 + ":6078/backstagegetpermissionfieldbyridsmid",
                data:datajson,
                dataType:"json",
                success: function(data) {
                    data.permissionfieldmap.sort(function(a,b){
                        return a.smdid-b.smdid;
                    });
                    searchfileds=[];
                    fields = [];
                    for (var i = 0; i < data.permissionfieldmap.length; i++) {
                        var fieldname=data.permissionfieldmap[i].fieldname;
                        if(fieldname!=="enable" && fieldname!=="password"){
                            fields.push(data.permissionfieldmap[i]);
                        }
                       
                    }
                    for(var tmp of fields){
                        if(tmp.fieldname!=="level" && tmp.fieldname!=="imgurl"){
                            if(tmp.fieldname=="role"){
                                var obj=new Object();
                                clone(obj,tmp);
                                obj.fieldname="rolename";
                                searchfileds.push(obj);
                            }else if(tmp.fieldname=="vid"){
                                var obj=new Object();
                                clone(obj,tmp);
                                obj.fieldname="venuename";
                                searchfileds.push(obj);
                            }else{
                                searchfileds.push(tmp);
                            }
						}
                    }
                    var th = document.getElementById("tabhead");
                    while (th.cells.length > 0) {
                        th.deleteCell(0);
                    }
                    for (var i = 0; i < fields.length; i++) {
                        var headcell = th.insertCell(i);
                        headcell.innerHTML = "<th><span>" + fields[i].name + "</span></th>";
                    }
                    var headoptcell = th.insertCell(fields.length);
                    headoptcell.innerHTML = "<th><span>" + "操 作" + "</span></th>";
                    initallrole();
                    initallvenue();
                    initTableData();

                },
                error: function(err) {
//						alert("err:" + err);
                }
            });
        }
        //克隆一个对象
        function clone(obj,tmp){
            for(var i in tmp){
                obj[i]=tmp[i];
            }
            return obj;
        }
        //角色列表初始化
        function initallrole(){

            var obj=new Object();
            var datajson=JSON.stringify(obj);
            $.ajax({
                type: "post",
                contentType:"application/x-www-form-urlencoded",
                data:datajson,
                dataType:"json",
                url:"http://" + url1 + ":6078/backstagegetroleservicenoadmin",
                success: function(data) {
                    //console.log(data);
                    freerole=[];
                    if(data.respVo.resultCode=="0"){
                        //console.log(data);
                        for(var i=0;i<data.rolemap.length;i++){
                            if(data.rolemap[i]["name"]!=="学员"){
                                freerole.push(data.rolemap[i]);
                            }
                        }
                    }else{
                        freerole.length=0;
                    }


                },
                error: function(err) {
//						alert("err:" + err);
                }
            });
        }
        //获取所有拳馆
        function initallvenue(){
            var obj=new Object();
            obj.vid=manager.vid;
            obj.page=1;
            obj.count=999999;
            var datajson=JSON.stringify(obj);
            $.ajax({
                type: "post",
                contentType:"application/x-www-form-urlencoded",
                data:datajson,
                dataType:"json",
                url:"http://" + url1 + ":6078/backstagegetvenue",
                success: function(data) {

                    data.VenueMap.sort(function(a,b){
                        return a.id-b.id;
                    });

                    freevenue=[];
                    if(data.respVo.resultCode=="0"){

                        //console.log(data);
                        for(var i=0;i<data.VenueMap.length;i++){

                                freevenue.push(data.VenueMap[i]);

                        }

                    }else{
                        freevenue.length=0;
                    }

                },
                error: function(err) {
//						alert("err:" + err);
                }
            });
        }

        //查询
        function inquiry() {
            var rolename=document.getElementById("rolename").value;
            if (window.sessionStorage) {
                sessionStorage.setItem("rolename2", rolename);

            } else {
                Cookie.write("rolename2", rolename);
            }
            initTableData()
        }
        //用户列表初始化
        function initTableData() {
            var rolename=window.sessionStorage ? sessionStorage.getItem("rolename2") : Cookie.read("rolename2");
            if(rolename==null){
                rolename="";
            }
            var obj=new Object();
            obj.name=rolename;
            obj.vid=manager.vid;
            obj.role=0;
            obj.page=page;
            obj.count=count;
            var datajson=JSON.stringify(obj);
            //console.log(datajson);
            $.ajax({
                type: "post",
                contentType:"application/x-www-form-urlencoded",
                data:datajson,
                dataType:"json",
                url:"http://" + url1 + ":6078/backstagegetuserbyname",
                success: function(data) {
                    //console.log(data);
                    //console.log(data.UserMap);
                    var table1 = document.getElementById('tbl');
                    dataarr = [];
                    while (table1.rows.length > 1) {
                        table1.deleteRow(1);
                    }
                    if(data.respVo.resultCode==0){
                        //设置排序
                        data.UserMap.sort(function sortId(a,b){
                            return b.id-a.id
                        });
                        //var res = jQuery.parseJSON(data);
                        if (window.sessionStorage ) {
                            updateUser1 = JSON.parse(sessionStorage.getItem("updateUser1")?sessionStorage.getItem("updateUser1"):"[]");
                        } else {
                            updateUser1 = JSON.parse(Cookie.read("updateUser1")?sessionStorage.getItem("updateUser1"):"[]");
                        }

                        for (var i = 0; i < data.UserMap.length; i++) {
                            if(updateUser1.length>0) {
                                for (var j = 0; j < updateUser1.length; j++) {
                                    if (data.UserMap[i].id == updateUser1[j].id) {
                                        data.UserMap[i] = updateUser1[j];
                                    }
                                }
                            }
                            dataarr.push(data.UserMap[i]);
                                var row = table1.insertRow(table1.rows.length);
                                //console.log(fields);

                                for (var k = 0; k < fields.length; k++) {
                                    var cell = row.insertCell(k);
                                    if(fields[k].fieldname=="level"){
                                        if(dataarr[i]["role"]==2){
                                            for(var level of levels){
                                                if(level[dataarr[i][fields[k].fieldname]]){
                                                    cell.innerHTML =level[dataarr[i][fields[k].fieldname]];
                                                }
                                            }
										}else if(dataarr[i]["role"]==3){
                                            for(var level of levels2){
                                                if(level[dataarr[i][fields[k].fieldname]]){
                                                    cell.innerHTML =level[dataarr[i][fields[k].fieldname]];
                                                }
                                            }
										}else if(dataarr[i]["role"]==5){
                                            cell.innerHTML ="暂无";
										}

                                    }else if(fields[k].fieldname=="imgurl"){
                                        cell.innerHTML = `<a onclick="handleClick(${i})" style="cursor: pointer">点击查看</a>`;
                                    }else{
                                        cell.innerHTML = fields[k].fieldname=="role"?data.UserMap[i]["rolename"]: fields[k].fieldname=="vid"?data.UserMap[i]["venuename"]?data.UserMap[i]["venuename"]:"暂无所属拳馆":dataarr[i][fields[k].fieldname]?dataarr[i][fields[k].fieldname]:"暂无";
                                    }
                                }
								var optcell = row.insertCell(fields.length);
								optcell.innerHTML = "<input type='image' src='../assets/img/bianji.png' id='bianji"+i+"'  value='' onclick='edit(" + i + ")'>" +
									"&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/dagl.png' id='xiangqing"+i+"' onclick='detail(" + i + ")'>" +
									"&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/lizhi.png' id='shanchu"+i+"' value='' onclick='del(" + i + ")' style='display: none'>";

								if(data.UserMap[i].enable== -1){
									optcell.innerHTML = "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/dagl.png' id='xiangqing"+i+"' onclick='detail(" + i + ")'>";
								}
                        }
                        maxpage = Math.ceil(data.respVo.resultDesc / count);
                        //设置分页
                        var first=$(".page>div>div:nth-child(1)");
                        var prev=$(".page>div>div:nth-child(2)");
                        var next=$(".page>div>div:nth-child(3)");
                        var last=$(".page>div>div:nth-child(4)");
                        if(page>1){
                            first.attr("class","blue")
                        }else{
                            first.attr("class","gray")
                        }
                        if(page>1){
                            prev.attr("class","blue")
                        }else{
                            prev.attr("class","gray")
                        }
                        if(page<maxpage){
                            next.attr("class","blue")
                        }else{
                            next.attr("class","gray")
                        }
                        if(page<maxpage){
                            last.attr("class","blue")
                        }else{
                            last.attr("class","gray")
                        }
                    }else{
                        //mizhu.alert('',data.respVo.resultDesc,'iconfont-close');
                    }
                },
                error: function(err) {
//						alert("err:" + err);
                }
            });

        }

        //图片上传
        function upload() {
            var formData = new FormData();
            var ifimgurl=document.getElementById("imgurltext");
            if(ifimgurl){
                formData.append("file", document.getElementById("imgurltext").files[0]);
            }else{
                formData.append("file", document.getElementById("imgurl").files[0]);
            }
            //console.log(document.getElementById("imgurltext").files[0]);
            $.ajax({
                url: "http://" + localhost + ":8080/taiji.tools/FileServlet?dir="+subpath,
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function(data) {
                },
                error: function() {
                    mizhu.alert('', '上传失败！','iconfont-close');
                }
            });
        }

        //查看照片
        function handleClick(idx){
            //console.log(dataarr[idx].imgurl);
            var s = document.getElementById("test");
            s.style.display = "block";
            var l = document.getElementById("user_photo");
            l.style.display = "block";
            var photo = document.getElementById("photo");
            if(dataarr[idx].imgurl){
                photo.innerHTML=`<img src="/taiji.tools/upload/${dataarr[idx].imgurl}"/>`;
            }else{
                photo.innerHTML=``;
            }


        }

        //新增用户
        function add1() {
            if(addable1 == 0){
                return;
            }
            currentIndex = -1;
            var s = document.getElementById("test");
            s.style.display = "block";
            var l = document.getElementById("log_window");
            l.style.display = "block";
            //console.log(fields);
            var user_add = document.getElementById('user_add');
            while (user_add.rows.length > 0) {
                user_add.deleteRow(0);
            }
            filedtop=[];
            for (var i = 1; i < fields.length; i++) {
                filedtop.push({fieldname:fields[i].fieldname});
                var row = user_add.insertRow(user_add.rows.length);
                if(i!==0){
                    if(fields[i].fieldname=="role" || fields[i].fieldname=="vid"){
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td style="padding-top: 18px">
								<select name="" id="${fields[i].fieldname}txt" style="border-radius: 0px;width: 95%" onchange="check${fields[i].fieldname}txt()"></select><br/>
								<span id="${fields[i].fieldname}txt_info"></span>
							</td>`;

                    }else if(fields[i].fieldname=="level"){
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td style="padding-top: 18px">
								<select name="" id="${fields[i].fieldname}txt" style="border-radius: 0px;width: 95%" onchange="check${fields[i].fieldname}txt()"></select><br/>
								<span id="${fields[i].fieldname}txt_info"></span>
							</td>`;
                        row.setAttribute("id","rowlevel");
					}else if(fields[i].fieldname=="imgurl"){
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td >
								<div style="width: 95%; margin: 0 auto"><input type="file" id="${fields[i].fieldname}" class="txt" name="moduletitle" style="border-radius: 0px; float: left" value="" /><div style="clear: both"></div></div>
								<span id="${fields[i].fieldname}txt_info"></span>
							</td>`;
					}else{
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td style="padding-top: 18px">
								<input type="text" id="${fields[i].fieldname}txt" class="txt" name="moduletitle" style="border-radius: 0px;width: 95%" value="" /><br />
								<span id="${fields[i].fieldname}txt_info"></span>
							</td>`;
                    }

                }

            }
            var select1 = document.getElementById("roletxt");
            while (select1.options.length > 0) {
                select1.remove(0);
            }
            if(freerole.length>0){
                select1.options.add(new Option("请选择角色",""));
                for (var i = 0; i < freerole.length; i++) {
                    select1.options.add(new Option(freerole[i].name,freerole[i].id));
                }
            }else{
                select1.options.add(new Option("暂无角色",""));
            }

            $("#roletxt").change(function(){
                var select2 = document.getElementById("leveltxt");
                while (select2.options.length > 0) {
                    select2.remove(0);
                }
                $("#rowlevel").css("display","table-row");
				if($(this).val()==2){
                    if(levels.length>0){
                        select2.options.add(new Option("请选择等级",""));
                    }else{
                        select2.options.add(new Option("暂无等级",""));
                    }
                    for (var level of levels) {
						Object.keys(level).forEach(function(key){
							select2.options.add(new Option(level[key],key));
						});
                	}
				}else if($(this).val()==3){
                    if(levels2.length>0){
                        select2.options.add(new Option("请选择等级",""));
                    }else{
                        select2.options.add(new Option("暂无等级",""));
                    }
                    for (var level of levels2) {
                        Object.keys(level).forEach(function(key){
                            select2.options.add(new Option(level[key],key));
                        });
                    }
				}else if($(this).val()==5){
                    select2.options.add(new Option(0,0));
                    $("#rowlevel").css("display","none");
				}
			});

            var select2 = document.getElementById("leveltxt");
            while (select2.options.length > 0) {
                select2.remove(0);
            }
            select2.options.add(new Option("请选择等级",""));

            var select3 = document.getElementById("vidtxt");
            while (select3.options.length > 0) {
                select3.remove(0);
            }
            if(freevenue.length>0) {
                select3.options.add(new Option("请选择所属拳馆", ""));
                for (var i = 0; i < freevenue.length; i++) {
                    select3.options.add(new Option(freevenue[i].name, freevenue[i].id));

                }
            }else{
                select3.options.add(new Option("暂无所属拳馆",""));
            }

            var optrow = user_add.insertRow(fields.length-1);
            optrow.innerHTML = `<tr>
					<td class="tableleft"></td>
					<td>
						<a  onclick="onSavebtnClickHandler()" class="save">保 存</a>
					</td>
				</tr>`;
        }

        //编辑用户
        function edit(idx) {

            if(updateable1 == 0){
                return;
            }
            var s = document.getElementById("test");
            s.style.display = "block";
            var l = document.getElementById("user_edit");
            l.style.display = "block";
            var table_edit = document.getElementById('table_edit');
            while (table_edit.rows.length > 0) {
                table_edit.deleteRow(0);
            }
            var editarr=[];
            filedtop=[];
            for (var i = 1; i < fields.length; i++) {
                editarr.push(fields[i]);
                filedtop.push({fieldname:fields[i].fieldname});
            }
            var obj =new Object();
            obj.uid=dataarr[idx].id;
            var datajson=JSON.stringify(obj);
            //console.log(datajson);
            $.ajax({
                type: "post",
                contentType:"application/x-www-form-urlencoded",
                data:datajson,
                dataType:"json",
                url:"http://" + url1 + ":6078/backstagegetuserproperty",
                success: function(data) {
                    //console.log(data)
                    //设置排序
                    data.UserPropertyMap.sort(function sortId(a,b){
                        return b.id-a.id
                    });
                    currentIndex = idx;
                    filebottom=[];
                    //console.log(dataarr[idx]);
                    for (var i = 0; i < data.UserPropertyMap.length; i++) {
                        if(data.UserPropertyMap[i].attrname!=="regaddr" && data.UserPropertyMap[i].attrname!=="eid") {
                            dataarr[idx][data.UserPropertyMap[i].attrname] = data.UserPropertyMap[i].avalue;
                            if (data.UserPropertyMap[i].attrname == "regaddr") {
                                dataarr[idx]["registvenuename"] = data.UserPropertyMap[i]["registvenuename"];
                            }
                            //console.log(data.UserPropertyMap[i]);
                            if (dataarr[idx].role == 3) {
                                editarr.push({
                                    name: data.UserPropertyMap[i].displayname,
                                    fieldname: data.UserPropertyMap[i].attrname,
                                    avalue: data.UserPropertyMap[i].avalue
                                });
                                filedbottom.push({fieldname: data.UserPropertyMap[i].attrname});
                            } else {
                                if (data.UserPropertyMap[i].attrname !== "coachexp") {
                                    editarr.push({
                                        name: data.UserPropertyMap[i].displayname,
                                        fieldname: data.UserPropertyMap[i].attrname,
                                        avalue: data.UserPropertyMap[i].avalue
                                    });
                                    filedbottom.push({fieldname: data.UserPropertyMap[i].attrname});
                                }
                            }
                        }

                    }
                    //console.log(editarr);
                    for (var i = 0; i < editarr.length; i++) {
						var row = table_edit.insertRow(table_edit.rows.length);
                        if(editarr[i].fieldname=="role" ||  editarr[i].fieldname=="vid" || editarr[i].fieldname=="regaddr" || editarr[i].fieldname=="gender"){
                            row.innerHTML+=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${editarr[i].name}</span></td>
								<td style="padding-top: 18px" vertical-align="top">
									<select name="" id="${editarr[i].fieldname}text" style="border-radius: 0px;width: 95%"></select><br/>
									<span id="${editarr[i].fieldname}text_info"></span>
								</td>`;

                        }else if(editarr[i].fieldname=="level"){
                            row.innerHTML+=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${editarr[i].name}</span></td>
								<td style="padding-top: 18px" vertical-align="top">
									<select name="" id="${editarr[i].fieldname}text" style="border-radius: 0px;width: 95%"></select><br/>
									<span id="${editarr[i].fieldname}text_info"></span>
								</td>`;
                            row.setAttribute("id","rowlevel2");
						}else if(editarr[i].fieldname=="coachexp"){
                            row.innerHTML+=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${editarr[i].name}</span></td>
								<td style="padding-top: 18px" vertical-align="top">
									<input type="${editarr[i].fieldname!=="password"?'text':'password'}" id="${editarr[i].fieldname}text" class="txt" name="moduletitle" style="border-radius: 0px;width: 95%" value="${dataarr[idx][editarr[i].fieldname] ?dataarr[idx][editarr[i].fieldname]:''}" /><br />
									<span id="${editarr[i].fieldname}text_info"></span>
								</td>`;
                            row.setAttribute("id","rowcoach");
						}else if(editarr[i].fieldname=="imgurl"){
                            row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${editarr[i].name}</span></td><td>
													<div style="width: 95%; margin: 0 auto; display: none" id="imgurl1"><input type="file" id="${editarr[i].fieldname}text" class="txt" name="moduletitle" style="border-radius: 0px; float: left"  /><div style="clear: both; height: 0px;"></div></div>
													<div style="width: 95%; margin: 0 auto; position: relative; top: 5px; " id="imgurl2"><input type="text" id="${editarr[i].fieldname}txt" class="txt" name="moduletitle" style="border-radius: 0px; float: left" value="${dataarr[idx][editarr[i].fieldname] ?dataarr[idx][editarr[i].fieldname]:''}" disabled="disabled" /><input type="button" value="重新上传" onclick="reload()" style="float: right"><div style="clear: both; height: 0px;"></div></div>
												    <span id="${editarr[i].fieldname}text_info"></span>
												</td>`;

                        }else{
                            row.innerHTML+=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${editarr[i].name}</span></td>
								<td style="padding-top: 18px" vertical-align="top">
									<input type="${editarr[i].fieldname!=="password"?'text':'password'}" id="${editarr[i].fieldname}text" class="txt" name="moduletitle" style="border-radius: 0px;width: 95%" value="${dataarr[idx][editarr[i].fieldname] ?dataarr[idx][editarr[i].fieldname]:''}" /><br />
									<span id="${editarr[i].fieldname}text_info"></span>
								</td>`;
                            laydate.render({
                                elem: '#birthdaytext' //指定元素
                                ,format: 'yyyy-MM-dd' //可任意组合
                                ,done: function(value, date){ //监听日期被切换
                                    var age=jsGetAge(value);
                                    $("#agetext").val(age);
                                }
                            });
                        }

                    }
                    var select1 = document.getElementById("roletext");
                    while (select1.options.length > 0) {
                        select1.remove(0);
                    }
                    if(parseInt(dataarr[idx].role)!==0){
                        select1.options.add(new Option(dataarr[idx].rolename,dataarr[idx].role));
                    }else{
                        select1.options.add(new Option("暂无角色",""));
                    }
                    //console.log(dataarr[idx].role);
                    for (var i = 0; i < freerole.length; i++) {
                        if(parseInt(freerole[i].id)!==parseInt(dataarr[idx].role)){
                            select1.options.add(new Option(freerole[i].name, freerole[i].id));

                        }
                    }

                    $("#roletext").change(function(){
                        var select2 = document.getElementById("leveltext");
                        while (select2.options.length > 0) {
                            select2.remove(0);
                        }
                        $("#rowlevel2").css("display","table-row");
                        $("#rowcoach").css("display","table-row");
                        if($(this).val()==2){
                            if(levels.length>0){
                                select2.options.add(new Option("请选择等级",""));
                            }else{
                                select2.options.add(new Option("暂无等级",0));
                            }
                            for (var level of levels) {
                                Object.keys(level).forEach(function(key){
                                    select2.options.add(new Option(level[key],key));
                                });
                            }
                            $("#rowcoach").css("display","none");
                        }else if($(this).val()==3){
                            if(levels2.length>0){
                                select2.options.add(new Option("请选择等级",""));
                            }else{
                                select2.options.add(new Option("暂无等级",""));
                            }
                            for (var level of levels2) {
                                Object.keys(level).forEach(function(key){
                                    select2.options.add(new Option(level[key],key));
                                });
                            }
                        }else if($(this).val()==5){
                            select2.options.add(new Option(0,0));
                            $("#rowlevel2").css("display","none");
                            $("#rowcoach").css("display","none");
                        }
                    });




                    var select2 = document.getElementById("leveltext");
                    while (select2.options.length > 0) {
                        select2.remove(0);
                    }
                    if(dataarr[idx].level){
                        if(dataarr[idx].role==2){
                            for (var level of levels) {
                                Object.keys(level).forEach(function(key) {
                                    if (parseInt(key) == parseInt(dataarr[idx].level)) {
                                        select2.options.add(new Option(level[key], dataarr[idx].level,true,true));
                                    }else{
                                        select2.options.add(new Option(level[key],key));
									}
                                });
                            }

						}else if(dataarr[idx].role==3){
                            for (var level of levels2) {
                                Object.keys(level).forEach(function(key) {
                                    if (parseInt(key) == parseInt(dataarr[idx].level)) {
                                        select2.options.add(new Option(level[key], dataarr[idx].level,true,true));
                                    }else{
                                        select2.options.add(new Option(level[key], key));
									}
                                });
                            }
						}else if(dataarr[idx].role==5){
                            select2.options.add(new Option("暂无指定等级",0));
						}

                    }else{
                        select2.options.add(new Option("暂无指定等级",0));
                    }



                    var select3 = document.getElementById("vidtext");
                    while (select3.options.length > 0) {
                        select3.remove(0);
                    }
                    if(dataarr[idx].venuename){
                        select3.options.add(new Option(dataarr[idx].venuename,dataarr[idx].vid));
                    }else{

                        select3.options.add(new Option("暂无所属拳馆",""));
                    }
                    //console.log(freevenue);
                    for (var i = 0; i < freevenue.length; i++) {
                        if(parseInt(freevenue[i].id)!==parseInt(dataarr[idx].vid)){
                            select3.options.add(new Option(freevenue[i].name, freevenue[i].id));
                        }
                    }

                    //console.log(dataarr[idx].gender);
                    var select5 = document.getElementById("gendertext");
                    while (select5.options.length > 0) {
                        select5.remove(0);
                    }
                    if(parseInt(dataarr[idx].gender)!==0){
                        for (var gender of genders) {
                            Object.keys(gender).forEach(function(key) {
                                if (parseInt(key) == parseInt(dataarr[idx].gender)) {
                                    select5.options.add(new Option(gender[key], dataarr[idx].gender));
                                }
                            });
                        }
                    }else{
                        select5.options.add(new Option("暂无指定性别",""));
                    }

                    for (var gender of genders) {
                        Object.keys(gender).forEach(function(key){
                            if(parseInt(key)!==parseInt(dataarr[idx].gender)){
                                select5.options.add(new Option(gender[key],key));
                            }
                        });
                    }


                    var optrow = table_edit.insertRow(table_edit.length);
                    optrow.innerHTML = `<tr>
							<td class="tableleft"></td>
							<td colspan="3">
								<a onclick="onSavebtnClickHandler(${dataarr[idx].id})" class="save">保 存</a>
							</td>
						</tr>`;

                },
                error: function(err) {
//						alert("err:" + err);
                }
            });
        }

        function reload(){
            document.getElementById("imgurltxt").value="";
            document.getElementById("imgurl2").style.display="none";
            document.getElementById("imgurl1").style.display="";
        }
        //计算生日
        function jsGetAge(strBirthday){
            var returnAge;
            var strBirthdayArr=strBirthday.split("-");
            var birthYear = strBirthdayArr[0];
            var birthMonth = strBirthdayArr[1];
            var birthDay = strBirthdayArr[2];
            d = new Date();
            var nowYear = d.getFullYear();
            var nowMonth = d.getMonth() + 1;
            var nowDay = d.getDate();

            if(nowYear == birthYear){
                returnAge = 0;//同年 则为0岁
            }else{
                var ageDiff = nowYear - birthYear ; //年之差
                if(ageDiff > 0){
                    if(nowMonth == birthMonth) {
                        var dayDiff = nowDay - birthDay;//日之差
                        if(dayDiff < 0)
                        {
                            returnAge = ageDiff - 1;
                        }
                        else
                        {
                            returnAge = ageDiff ;
                        }
                    }
                    else
                    {
                        var monthDiff = nowMonth - birthMonth;//月之差
                        if(monthDiff < 0)
                        {
                            returnAge = ageDiff - 1;
                        }
                        else
                        {
                            returnAge = ageDiff ;
                        }
                    }
                }
                else
                {
                    returnAge = -1;//返回-1 表示出生日期输入错误 晚于今天
                }
            }
            return returnAge;//返回周岁年龄
        }

        //用户详情
        function detail(idx) {
            if(updateable1 == 0){
                return;
            }
            var s = document.getElementById("test");
            s.style.display = "block";
            var l = document.getElementById("user_info");
            l.style.display = "block";

            //currentIndex = idx;
            var obj =new Object();
            obj.uid=dataarr[idx].id;
            var datajson=JSON.stringify(obj);
            $.ajax({
                type: "post",
                contentType:"application/x-www-form-urlencoded",
                data:datajson,
                dataType:"json",
                url:"http://" + url1 + ":6078/backstagegetuserproperty",
                success: function(data) {
//设置排序
                    data.UserPropertyMap.sort(function sortId(a,b){
                        return b.id-a.id
                    });
                    //var res = jQuery.parseJSON(data);
                    var table_info = document.getElementById('table_info');
                    while (table_info.rows.length > 0) {
                        table_info.deleteRow(0);
                    }
                    //console.log(data.UserPropertyMap);

                    for (var i = 1; i < fields.length; i++) {
                        var row = table_info.insertRow(table_info.rows.length);
                        if(fields[i].fieldname=="imgurl"){
                            if(dataarr[idx][fields[i].fieldname]){
                                row.innerHTML=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${fields[i].name}</span></td>
									<td style="width: 75%"><img src="/taiji.tools/upload/${dataarr[idx][fields[i].fieldname]}"/></td>`
                            }else{
                                row.innerHTML=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${fields[i].name}</span></td>
									<td style="width: 75%"></td>`;
                            }
                        }else if(fields[i].fieldname=="role"){

                            for (var k = 0; k < freerole.length; k++) {
                                if(parseInt(freerole[k].id)==parseInt(dataarr[idx].role)){
                                    row.innerHTML=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${fields[i].name}</span></td>
										<td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${freerole[k].name}</p></td>`;

                                }
                            }

						}else if(fields[i].fieldname=="level"){

                            if(dataarr[idx].role==2){
                                for (var level of levels) {
                                    Object.keys(level).forEach(function(key) {
                                        if (parseInt(key) == parseInt(dataarr[idx].level)) {
                                            row.innerHTML=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${fields[i].name}</span></td>
											<td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${level[key]}</p></td>`;
                                        }
                                    });
                                }

                            }else if(dataarr[idx].role==3){
                                for (var level of levels2) {
                                    Object.keys(level).forEach(function(key) {
                                        if (parseInt(key) == parseInt(dataarr[idx].level)) {
                                            row.innerHTML=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${fields[i].name}</span></td>
											<td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${level[key]}</p></td>`;
                                        }
                                    });
                                }
                            }else if(dataarr[idx].role==5){
                                row.innerHTML=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${fields[i].name}</span></td>
											<td style="padding-top: 18px;width: 75%"><p style="text-align:left;">暂无</p></td>`;

                            }


						}else if(fields[i].fieldname=="vid"){
                            for (var k = 0; k < freevenue.length; k++) {
                                if(parseInt(freevenue[k].id)==parseInt(dataarr[idx].vid)){
                                    row.innerHTML=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${fields[i].name}</span></td>
									<td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${freevenue[k].name}</p></td>`;
                                }
                            }
						}else{
                            row.innerHTML=`<td class="tableleft" vertical-align="top"><span class="tanKuangSpan">${fields[i].name}</span></td>
								<td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${dataarr[idx][fields[i].fieldname] ?dataarr[idx][fields[i].fieldname]:''}</p></td>`;
                        }

                    }

                    for (var i = 0; i < data.UserPropertyMap.length; i++) {
                        if(data.UserPropertyMap[i].attrname!=="regaddr" && data.UserPropertyMap[i].attrname!=="eid") {
                            var row = table_info.insertRow(table_info.rows.length);
                            if (data.UserPropertyMap[i].attrname == "gender") {
                                var ifGender = 0;
                                for (var gender of genders) {
                                    if (gender[data.UserPropertyMap[i].avalue]) {
                                        ifGender++;
                                        row.innerHTML = `<td class="tableleft"><span class="tanKuangSpan">${data.UserPropertyMap[i].displayname}</span></td>
								        <td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${gender[data.UserPropertyMap[i].avalue]}</p></td>`;
                                    }
                                }
                                if (ifGender == 0) {
                                    row.innerHTML = `<td class="tableleft"><span class="tanKuangSpan">${data.UserPropertyMap[i].displayname}</span></td>
							       <td style="padding-top: 18px;width: 75%"><p style="text-align:left;">暂无指定性别</p></td>`;
                                }
                            } else {
                                if (dataarr[idx].role !== 3) {
                                    //控制教练教龄字段显示与隐藏
                                    if (data.UserPropertyMap[i].attrname == "coachexp") {
                                        row.innerHTML = `<td class="tableleft"><span class="tanKuangSpan">${data.UserPropertyMap[i].displayname}</span></td>
									    <td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${data.UserPropertyMap[i].attrname == "regaddr" ? data.UserPropertyMap[i].registvenuename ? data.UserPropertyMap[i].registvenuename : "暂无注册拳馆" : data.UserPropertyMap[i].avalue}</p></td>`;
                                        row.style.display = "none";
                                    } else {
                                        row.innerHTML = `<td class="tableleft"><span class="tanKuangSpan">${data.UserPropertyMap[i].displayname}</span></td>
									    <td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${data.UserPropertyMap[i].attrname == "regaddr" ? data.UserPropertyMap[i].registvenuename ? data.UserPropertyMap[i].registvenuename : "暂无注册拳馆" : data.UserPropertyMap[i].avalue}</p></td>`;
                                    }

                                } else {
                                    row.innerHTML = `<td class="tableleft"><span class="tanKuangSpan">${data.UserPropertyMap[i].displayname}</span></td>
									<td style="padding-top: 18px;width: 75%"><p style="text-align:left;">${data.UserPropertyMap[i].attrname == "regaddr" ? data.UserPropertyMap[i].registvenuename ? data.UserPropertyMap[i].registvenuename : "暂无注册拳馆" : data.UserPropertyMap[i].avalue}</p></td>`;
                                }

                            }
                        }

                    }
                },
                error: function(err) {
//						alert("err:" + err);
                }
            });

        }



        //删除用户
        function del(idx) {
            if(delable1 == 0){
                return;
            }
            if (confirm("确定要离职吗？")) {
                var obj=new Object();
                obj.id=dataarr[idx].id;
                var datajson=JSON.stringify(obj);
                $.ajax({
                    type: "post",
                    contentType:"application/x-www-form-urlencoded",
                    dataType:"json",
                    data:datajson,
                    url:"http://" + url1 + ":6078/backstagedeluser",
                    success: function(data) {
                        dataarr[idx].enable=-1;
                        if (window.sessionStorage) {
                            updateUser1 = JSON.parse(sessionStorage.getItem("updateUser1")?sessionStorage.getItem("updateUser1"):"[]");
                            if(updateUser1.length>0) {
                                var len=0;
                                for (var j = 0; j < updateUser1.length; j++) {
                                    if (dataarr[idx].id == updateUser1[j].id) {
                                        len++;
                                        updateUser1[j]=dataarr[idx];
                                    }
                                }
                                if(len==0){
                                    updateUser1.push(dataarr[idx]);
                                }
                                sessionStorage.setItem("updateUser1", JSON.stringify(updateUser1));
                            }else{
                                updateUser1.push(dataarr[idx]);
                                sessionStorage.setItem("updateUser1", JSON.stringify(updateUser1));
                            }
                        } else {
                            updateUser1 = JSON.parse(Cookie.read("updateUser1")?Cookie.read("updateUser1"):"[]");
                            if(updateUser1.length>0) {
                                var len=0;
                                for (var j = 0; j < updateUser1.length; j++) {
                                    if (dataarr[idx].id == updateUser1[j].id) {
                                        len++;
                                        updateUser1[j]=dataarr[idx];
                                    }
                                }
                                if(len==0){
                                    updateUser1.push(dataarr[idx]);
                                }
                                Cookie.write("updateUser1", JSON.stringify(updateUser1));
                            }else{
                                updateUser1.push(dataarr[idx]);
                                Cookie.write("updateUser1", JSON.stringify(updateUser1));
                            }
                        }
                        init();
                    },
                    error: function(err) {
                        //mizhu.alert('', 'err:'+ err,'iconfont-gou');
                    }
                });
            }
        }


        //验证
        function checknametext(){
            var nametext = document.getElementById("nametext");
            var nametext_info = document.getElementById("nametext_info");
            if (nametext.value == "") {
                nametext_info.innerHTML = "该字段不能为空";
                nametext.style.border = "1px solid red";
                nametext_info.style.color = "red";
                return false;
            }
            else {
                nametext_info.innerHTML = "";
                nametext.style.border = "";
                return true;
            }
        }
        function checknametxt(){
            var nametxt = document.getElementById("nametxt");
            var nametxt_info = document.getElementById("nametxt_info");
            if (nametxt.value == "") {
                nametxt_info.innerHTML = "该字段不能为空";
                nametxt.style.border = "1px solid red";
                nametxt_info.style.color = "red";
                return false;
            }
            else {
                nametxt_info.innerHTML = "";
                nametxt.style.border = "";
                return true;
            }
        }
        function checknicknametext(){
            var nicknametext = document.getElementById("nicknametext");
            var nicknametext_info = document.getElementById("nicknametext_info");
            if (nicknametext.value == "") {
                nicknametext_info.innerHTML = "该字段不能为空";
                nicknametext.style.border = "1px solid red";
                nicknametext_info.style.color = "red";
                return false;
            }
            else {
                nicknametext_info.innerHTML = "";
                nicknametext.style.border = "";
                return true;
            }
        }
        function checknicknametxt(){
            var nicknametxt = document.getElementById("nicknametxt");
            var nicknametxt_info = document.getElementById("nicknametxt_info");
            if (nicknametxt.value == "") {
                nicknametxt_info.innerHTML = "该字段不能为空";
                nicknametxt.style.border = "1px solid red";
                nicknametxt_info.style.color = "red";
                return false;
            }
            else {
                nicknametxt_info.innerHTML = "";
                nicknametxt.style.border = "";
                return true;
            }
        }
        function checkroletext(){
            var roletext = document.getElementById("roletext");
            var roletext_info = document.getElementById("roletext_info");
            if (roletext.value == "") {
                roletext_info.innerHTML = "该字段不能为空";
                roletext.style.border = "1px solid red";
                roletext_info.style.color = "red";
                return false;
            }
            else {
                roletext_info.innerHTML = "";
                roletext.style.border = "";
                return true;
            }
        }
        function checkroletxt(){
            var roletxt = document.getElementById("roletxt");
            var roletxt_info = document.getElementById("roletxt_info");
            if (roletxt.value == "") {
                roletxt_info.innerHTML = "该字段不能为空";
                roletxt.style.border = "1px solid red";
                roletxt_info.style.color = "red";
                return false;
            }
            else {
                roletxt_info.innerHTML = "";
                roletxt.style.border = "";
                return true;
            }
        }
        function checkleveltext(){
            var leveltext = document.getElementById("leveltext");
            var leveltext_info = document.getElementById("leveltext_info");
            if (leveltext.value == "") {
                leveltext_info.innerHTML = "该字段不能为空";
                leveltext.style.border = "1px solid red";
                leveltext_info.style.color = "red";
                return false;
            }
            else {
                var reg=new RegExp("^[0-9]{1,}$","g");
                if(!reg.test(leveltext.value)){
                    leveltext_info.innerHTML = "该字段必须为数字";
                    leveltext.style.border = "1px solid red";
                    leveltext_info.style.color = "red";
                    return false;
                }else{
                    leveltext_info.innerHTML = "";
                    leveltext.style.border = "";
                    return true;
                }
            }

        }
        function checkleveltxt(){
            var leveltxt = document.getElementById("leveltxt");
            var leveltxt_info = document.getElementById("leveltxt_info");
            if (leveltxt.value == "") {
                leveltxt_info.innerHTML = "该字段不能为空";
                leveltxt.style.border = "1px solid red";
                leveltxt_info.style.color = "red";
                return false;
            }
            else {
                var reg=new RegExp("^[0-9]{1,}$","g");
                if(!reg.test(leveltxt.value)){
                    leveltxt_info.innerHTML = "该字段必须为数字";
                    leveltxt.style.border = "1px solid red";
                    leveltxt_info.style.color = "red";
                    return false;
                }else{
                    leveltxt_info.innerHTML = "";
                    leveltxt.style.border = "";
                    return true;
                }
            }

        }
        function checkphonenumtext(){
            var phonenumtext = document.getElementById("phonenumtext");
            var phonenumtext_info = document.getElementById("phonenumtext_info");
            if (phonenumtext.value == "") {
                phonenumtext_info.innerHTML = "该字段不能为空";
                phonenumtext.style.border = "1px solid red";
                phonenumtext_info.style.color = "red";
                return false;
            }
            else {
                var reg=new RegExp(/^((13[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(18[0,5-9]))\d{8}$/);
                if(!reg.test(phonenumtext.value)){
                    phonenumtext_info.innerHTML = "该字段格式不正确";
                    phonenumtext.style.border = "1px solid red";
                    phonenumtext_info.style.color = "red";
                    return false;
                }else{
                    phonenumtext_info.innerHTML = "";
                    phonenumtext.style.border = "";
                    return true;
                }
            }
        }
        function checkphonenumtxt(){

            var phonenumtxt = document.getElementById("phonenumtxt");
            var phonenumtxt_info = document.getElementById("phonenumtxt_info");
            if (phonenumtxt.value == "") {
                phonenumtxt_info.innerHTML = "该字段不能为空";
                phonenumtxt.style.border = "1px solid red";
                phonenumtxt_info.style.color = "red";
                return false;
            }
            else {

                var reg=new RegExp(/^((13[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(18[0,5-9]))\d{8}$/);

                if(!reg.test(phonenumtxt.value)){
                    phonenumtxt_info.innerHTML = "该字段格式不正确";
                    phonenumtxt.style.border = "1px solid red";
                    phonenumtxt_info.style.color = "red";
                    return false;
                }else{
                    phonenumtxt_info.innerHTML = "";
                    phonenumtxt.style.border = "";
                    return true;
                }

            }
        }
        function checkvidtext(){
            var vidtext = document.getElementById("vidtext");
            var vidtext_info = document.getElementById("vidtext_info");
            if (vidtext.value == "") {
                vidtext_info.innerHTML = "该字段不能为空";
                vidtext.style.border = "1px solid red";
                vidtext_info.style.color = "red";
                return false;
            }
            else {
                vidtext_info.innerHTML = "";
                vidtext.style.border = "";
                return true;
            }
        }
        function checkvidtxt(){
            var vidtxt = document.getElementById("vidtxt");
            var vidtxt_info = document.getElementById("vidtxt_info");
            if (vidtxt.value == "") {
                vidtxt_info.innerHTML = "该字段不能为空";
                vidtxt.style.border = "1px solid red";
                vidtxt_info.style.color = "red";
                return false;
            }
            else {
                vidtxt_info.innerHTML = "";
                vidtxt.style.border = "";
                return true;
            }
        }
        function checkbirthdaytext(){
            var birthdaytext = document.getElementById("birthdaytext");
            var birthdaytext_info = document.getElementById("birthdaytext_info");
            if (birthdaytext.value == "") {
                birthdaytext_info.innerHTML = "该字段不能为空";
                birthdaytext.style.border = "1px solid red";
                birthdaytext_info.style.color = "red";
                return false;
            }
            else {
                birthdaytext_info.innerHTML = "";
                birthdaytext.style.border = "";
                return true;
            }
        }
        function checkmailtext(){
            var mailtext = document.getElementById("mailtext");
            var mailtext_info = document.getElementById("mailtext_info");
            if (mailtext.value == "") {
                mailtext_info.innerHTML = "该字段不能为空";
                mailtext.style.border = "1px solid red";
                mailtext_info.style.color = "red";
                return false;
            }
            else {

                var reg=new RegExp(/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/,"ig");

                if(!reg.test(mailtext.value)){
                    mailtext_info.innerHTML = "该字段格式不正确";
                    mailtext.style.border = "1px solid red";
                    mailtext_info.style.color = "red";
                    return false;
                }else{
                    mailtext_info.innerHTML = "";
                    mailtext.style.border = "";
                    return true;
                }

            }
        }
        function checkimgurltxt(){
            var imgurltxt = document.getElementById("imgurl");
            var imgurltxt_info = document.getElementById("imgurltxt_info");
            console.log(imgurltxt);
            if (!imgurltxt.files[0]) {
                imgurltxt_info.innerHTML = "该字段不能为空";
                imgurltxt_info.style.color = "red";
                return false;
            }else {
                imgurltxt_info.innerHTML = "";
                imgurltxt.style.border = "";
                return true;
            }
        }
        function checkimgurltext(){
            var imgurltxt = document.getElementById("imgurltxt");
            var imgurltext = document.getElementById("imgurltext");
            var imgurltext_info = document.getElementById("imgurltext_info");
            if (!imgurltext.files[0]) {
                if(imgurltxt.value==""){
                    imgurltext_info.innerHTML = "该字段不能为空";
                    imgurltext_info.style.color = "red";
                    return false;
                }else{
                    imgurltext_info.innerHTML = "";
                    imgurltext.style.border = "";
                    return true;
                }
            }else{
                imgurltext_info.innerHTML = "";
                imgurltext.style.border = "";
                return true;
            }
        }
        function checkidnumtxt(){
            var idnumtxt = document.getElementById("idnumtxt");
            var idnumtxt_info = document.getElementById("idnumtxt_info");
            if (idnumtxt.value == "") {
                idnumtxt_info.innerHTML = "该字段不能为空";
                idnumtxt.style.border = "1px solid red";
                idnumtxt_info.style.color = "red";
                return false;
            }else {
                var reg=new RegExp(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/,"ig");
                if(!reg.test(idnumtxt.value)){
                    idnumtxt_info.innerHTML = "该字段格式不正确";
                    idnumtxt.style.border = "1px solid red";
                    idnumtxt_info.style.color = "red";
                    return false;
                }else{
                    idnumtxt_info.innerHTML = "";
                    idnumtxt.style.border = "";
                    return true;
                }

            }
        }
        function checkidnumtext(){
            var idnumtext = document.getElementById("idnumtext");
            var idnumtext_info = document.getElementById("idnumtext_info");
            if (idnumtext.value == "") {
                idnumtext_info.innerHTML = "该字段不能为空";
                idnumtext.style.border = "1px solid red";
                idnumtext_info.style.color = "red";
                return false;
            }else {
                var reg=new RegExp(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/,"ig");
                if(!reg.test(idnumtext.value)){
                    idnumtext_info.innerHTML = "该字段格式不正确";
                    idnumtext.style.border = "1px solid red";
                    idnumtext_info.style.color = "red";
                    return false;
                }else{
                    idnumtext_info.innerHTML = "";
                    idnumtext.style.border = "";
                    return true;
                }

            }
        }

        //保存添加的用户
        function onSavebtnClickHandler(id,requrl = "") {
            //console.log(111);
            var datajson;
            if (requrl == undefined || requrl.length == 0) {
                if (currentIndex >= 0) {
                    if(checknametext()&&checknicknametext()&&checkroletext()&&checkleveltext()&&checkphonenumtext()&&checkvidtext()&&checkidnumtext()&&checkimgurltext()&&checkmailtext()&&checkbirthdaytext()){
                        var url="http://" + url1 + ":6078/backstageupdateuser";
                        var obj=new Object();
                        obj.id=id;
                        for(var i=0;i<filedtop.length;i++){
                            if(filedtop[i].fieldname=="imgurl"){
                                var ifimgurl=document.getElementById(filedtop[i].fieldname+'text').files[0];
                               // console.log(ifimgurl);
                                if(ifimgurl){
                                    obj[filedtop[i].fieldname]="/" + subpath + "/" + document.getElementById(filedtop[i].fieldname+'text').files[0].name;
                                }else{
                                    obj[filedtop[i].fieldname]=document.getElementById(filedtop[i].fieldname+'txt').value;
                                }
                            }else{
                                obj[filedtop[i].fieldname]=document.getElementById(filedtop[i].fieldname+'text').value;
                            }
                        }
                        datajson=JSON.stringify(obj);
                        //console.log(datajson);
                        var url2="http://" + url1 + ":6078/updateuser";
                        var obj2=new Object();
                        obj2.uid=id;
                        var attrnames=[];

                        for(var i=0;i<filedbottom.length;i++){
                            attrnames.push(filedbottom[i].fieldname);
                        }
                        obj2.attrnames=attrnames.join();
                        var avalues=[];
                        for(var i=0;i<filedbottom.length;i++){
                            var val=document.getElementById(filedbottom[i].fieldname+'text').value;
                            if(val){
                                avalues.push(val);
                            }else{
                                avalues.push("null");
                            }

                        }
                        obj2.avalues=avalues.join();
                        var enables=[];
                        for(var i=0;i<filedbottom.length;i++){
                            enables.push(1);
                        }
                        obj2.enables=enables.join();
                        var editables=[];
                        for(var i=0;i<filedbottom.length;i++){
                            editables.push(1);
                        }
                        obj2.editables=editables.join();
                        datajson2=JSON.stringify(obj2);
                        //console.log(datajson2);
                        save();
                    }else{
                        mizhu.alert('', '请正确完善信息','iconfont-close');
                    }

                } else {
                    if(checknametxt()&&checknicknametxt()&&checkroletxt()&&checkleveltxt()&&checkphonenumtxt()&&checkvidtxt()&&checkidnumtxt()&&checkimgurltxt()){
                        var url="http://" + url1 + ":6078/backstageadduser";
                        var obj=new Object();
                        for(var i=0;i<filedtop.length;i++){
                            if(filedtop[i].fieldname=="imgurl"){
                                obj[filedtop[i].fieldname]="/" + subpath + "/" + document.getElementById(filedtop[i].fieldname).files[0].name;
                            }else{
                                obj[filedtop[i].fieldname]=document.getElementById(filedtop[i].fieldname+'txt').value;
                            }
                        }
                        datajson=JSON.stringify(obj);
						//console.log(datajson);
                        save();
                    }else{
                        mizhu.alert('', '请正确完善信息','iconfont-close');
                    }

                }
            }
            function save(){
                $.ajax({
                    type: "post",
                    contentType:"application/x-www-form-urlencoded",
                    data:datajson,
                    dataType:"json",
                    url:url,
                    success: function(data) {
                        //console.log(data);
                        if (currentIndex >= 0) {
                            if(data.respVo.resultCode<0){
                                mizhu.alert('',data.respVo.resultDesc,'iconfont-close');
                                return;
                            }else{
                                $.ajax({
                                    type: "post",
                                    contentType: "application/x-www-form-urlencoded",
                                    data: datajson2,
                                    dataType: "json",
                                    url: url2,
                                    success: function (data) {
                                        datajson=JSON.parse(datajson);
                                        datajson.rolename=$("#roletext option:selected").text();
                                        datajson.venuename=$("#vidtext option:selected").text();
                                        datajson2=JSON.parse(datajson2);
                                        datajson2.registvenuename=$("#regaddrtext option:selected").text();
                                        if (window.sessionStorage) {
                                            updateUser1 = JSON.parse(sessionStorage.getItem("updateUser1")?sessionStorage.getItem("updateUser1"):"[]");
                                            if(updateUser1.length>0) {
                                                var len=0;
                                                for (var j = 0; j < updateUser1.length; j++) {
                                                    //console.log(updateVenue[j].id+"b");
                                                    if (datajson.id == updateUser1[j].id) {
                                                        len++;
                                                        updateUser1[j]=datajson;
                                                    }
                                                }
                                                if(len==0){
                                                    updateUser1.push(datajson);
                                                }
                                                sessionStorage.setItem("updateUser1", JSON.stringify(updateUser1));
                                            }else{
                                                updateUser1.push(datajson);
                                                sessionStorage.setItem("updateUser1", JSON.stringify(updateUser1));
                                            }
                                        } else {
                                            updateUser1 = JSON.parse(Cookie.read("updateUser1")?Cookie.read("updateUser1"):"[]");
                                            if(updateUser1.length>0) {
                                                var len=0;
                                                for (var j = 0; j < updateUser1.length; j++) {
                                                    if (datajson.id == updateUser1[j].id) {
                                                        len++;
                                                        updateUser1[j]=datajson;
                                                    }
                                                }
                                                if(len==0){
                                                    updateUser1.push(datajson);
                                                }
                                                Cookie.write("updateUser1", JSON.stringify(updateUser1));
                                            }else{
                                                updateUser1.push(datajson);
                                                Cookie.write("updateUser1", JSON.stringify(updateUser1));
                                            }
                                        }
                                        upload();
                                        mizhu.alert('', '修改成功','iconfont-gou');
                                        init();
                                        cancel_shield();

                                    },
                                    error: function (err) {
                                        mizhu.alert('', '修改失败','iconfont-close');
                                        cancel_shield();
                                    }
                                });
                            }

                        }else{

                            if(data.respVo.resultCode<0){
                                alert(data.respVo.resultDesc);
                                return;
                            }else{
                                upload();
                                mizhu.alert('', '添加成功','iconfont-gou');
                                init();
                                cancel_shield();
							}

                        }

                    },
                    error: function(err) {
                        mizhu.alert('', '添加失败','iconfont-close');
                        cancel_shield();
                    }
                });
            }




        }






        //关闭弹出的div
        function cancel_shield() {
            var s = document.getElementById("test");
            s.style.display = "none";
            var e = document.getElementById("user_edit");
            e.style.display = "none";
            var l = document.getElementById("log_window");
            l.style.display = "none";
            var i = document.getElementById("user_info");
            i.style.display = "none";
            var p = document.getElementById("user_photo");
            p.style.display = "none";
            var m = document.getElementById("mytooltip");
            m.style.display = "none";
        }


        //分页
        function first(){
            if(document.getElementById("pagelab").value==1){
                mizhu.alert('', '当前已经为第一页！','iconfont-close');
            }
            else{
                initTable(1,true);
            }

        }
        function last(){

            if(document.getElementById("pagelab").value==maxpage){
                mizhu.alert('', '当前已经为最后页！','iconfont-close');
            }
            else{
                initTable(parseInt(maxpage),true);
            }

        }

        function initTable(step, flag = false) {
            initFields();
            step = parseInt(step);
            var p = parseInt(page) + parseInt(step);
            if (flag) {
                if (step < 1 || step > maxpage) {
                    mizhu.alert('', '页码超标','iconfont-close');
                    return;
                }
                page = step;
            } else {
                page = p;
                if (page < 1 || page > maxpage) {
                    page -= step;
                    return;
                }
            }
            var rolename=window.sessionStorage ? sessionStorage.getItem("rolename2") : Cookie.read("rolename2");
            if(rolename==null){
                rolename="";
            }

            var obj=new Object();
            obj.name=rolename;
            obj.vid=manager.vid;
            obj.role=0;
            obj.page=page;
            obj.count=count;
            var datajson=JSON.stringify(obj);
            $.ajax({
                type: "post",
                contentType:"application/x-www-form-urlencoded",
                data:datajson,
                dataType:"json",
                url:"http://" + url1 + ":6078/backstagegetuserbyname",
                success: function(data) {
                    var table1 = document.getElementById('tbl');
                    dataarr = [];
                    while (table1.rows.length > 1) {
                        table1.deleteRow(1);
                    }
                    //设置排序
                    data.UserMap.sort(function sortId(a,b){
                        return b.id-a.id
                    });
                    //var res = jQuery.parseJSON(data);
                    if (window.sessionStorage ) {
                        updateUser1 = JSON.parse(sessionStorage.getItem("updateUser1")?sessionStorage.getItem("updateUser1"):"[]");
                    } else {
                        updateUser1 = JSON.parse(Cookie.read("updateUser1")?sessionStorage.getItem("updateUser1"):"[]");
                    }

                    for (var i = 0; i < data.UserMap.length; i++) {
                        if(updateUser1.length>0) {
                            for (var j = 0; j < updateUser1.length; j++) {
                                if (data.UserMap[i].id == updateUser1[j].id) {
                                    data.UserMap[i] = updateUser1[j];
                                }
                            }
                        }
                        dataarr.push(data.UserMap[i]);
                        var row = table1.insertRow(table1.rows.length);
                        //console.log(fields);

                        for (var k = 0; k < fields.length; k++) {
                            var cell = row.insertCell(k);
                            if(fields[k].fieldname=="level"){
                                if(dataarr[i]["role"]==2){
                                    for(var level of levels){
                                        if(level[dataarr[i][fields[k].fieldname]]){
                                            cell.innerHTML =level[dataarr[i][fields[k].fieldname]];
                                        }
                                    }
                                }else if(dataarr[i]["role"]==3){
                                    for(var level of levels2){
                                        if(level[dataarr[i][fields[k].fieldname]]){
                                            cell.innerHTML =level[dataarr[i][fields[k].fieldname]];
                                        }
                                    }
                                }else if(dataarr[i]["role"]==5){
                                    cell.innerHTML ="暂无";
                                }

                            }else if(fields[k].fieldname=="imgurl"){
                                cell.innerHTML = `<a onclick="handleClick(${i})" style="cursor: pointer">点击查看</a>`;
                            }else{
                                cell.innerHTML = fields[k].fieldname=="role"?data.UserMap[i]["rolename"]: fields[k].fieldname=="vid"?data.UserMap[i]["venuename"]?data.UserMap[i]["venuename"]:"暂无所属拳馆":dataarr[i][fields[k].fieldname]?dataarr[i][fields[k].fieldname]:"暂无";
                            }
                        }
                        var optcell = row.insertCell(fields.length);
                        optcell.innerHTML = "<input type='image' src='../assets/img/bianji.png' id='bianji"+i+"'  value='' onclick='edit(" + i + ")'>" +
                            "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/dagl.png' id='xiangqing"+i+"' onclick='detail(" + i + ")'>" +
                            "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/lizhi.png' id='shanchu"+i+"' value='' onclick='del(" + i + ")' style='display: none'>";

                        if(data.UserMap[i].enable== -1){
                            optcell.innerHTML = "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/dagl.png' id='xiangqing"+i+"' onclick='detail(" + i + ")'>";
                        }
                    }
                    maxpage = Math.ceil(data.respVo.resultDesc / count);
                    document.getElementById('pagelab').value = page;
//                        if (window.sessionStorage) {
//                            sessionStorage.setItem("Node_page", page);
//                        } else {
//                            Cookie.write("Node_page", page);
//                        }
                },
                error: function(err) {
//						alert("err:" + err);
                }
            });
        }

        function pageKeyUpHandler(evt) {
            if (evt.keyCode == 13) {
                initTable(parseInt(document.getElementById("pagelab").value), true);
            }
        }


        //权限增删改
        function isdisadd(obj) {

            var idstr = obj.id;

            if (addable1 == 0 && idstr.indexOf("add")>=0){
                document.getElementById(idstr).disabled = 'disabled';
                document.getElementById(idstr).style.cursor = "not-allowed";
            }

            if (updateable1 == 0 && idstr.indexOf("bian")>=0){
                document.getElementById(idstr).disabled = 'disabled';
                document.getElementById(idstr).style.cursor = "not-allowed";
            }

            if (delable1 == 0 && idstr.indexOf("shan")>=0){
                document.getElementById(idstr).disabled = 'disabled';
                document.getElementById(idstr).style.cursor = "not-allowed";
            }
        }

        function isdisout(obj) {
            var idstr = obj.id;
            document.getElementById(idstr).disabled = false;
            document.getElementById(idstr).style.cursor = "pointer";
        }






	</script>
</head>
<body onload="init()">
<div class="onclick">
	<input type="text" style="width: 200px;height:25px;border-radius: 0px;" name="rolename" id="rolename" class="abc input-default" placeholder="&nbsp;按工号/手机号查询" value="" data-genuitec-lp-enabled="false"
		   data-genuitec-file-id="wc1-67" data-genuitec-path="/fkds1.5.tools/WebRoot/tools/shop/index.html" >&nbsp;&nbsp;&nbsp;
	<a onclick="inquiry()" id="chaxun"  class="search" >搜索</a>&nbsp;&nbsp;&nbsp;
	<a id="addnew1" onclick="add1()" class="add">新 增</a>
</div>
<!--<a  id="qingkong" onclick="qingkong()"><image style="margin-top: 10px" src="../assets/img/xinzeng.png"></image></a>-->
<table class="table table-hover definewidth m10" id="tbl">
	<thead id="thead">
	<tr id="tabhead" class="theadColor">
	</tr>
	</thead>
</table>

<div class="inline pull-right page">
	<div class="first" onclick="first()">第一页</div>
	<div class="prev" onclick="initTable(-1)">上一页</div>
	<div class="next" onclick="initTable(1)">下一页</div>
	<div class="last" onclick="last()">最后一页</div>
	<div class="clearfix"></div>
	<input type="hidden" id="pagelab" style="width: 50px;height:22px;overflow:hidden;margin-right: 5px;text-align: center;border-radius: 0px" onkeyup="pageKeyUpHandler(event)">
</div>

<!--//弹出遮罩-->
<div id="test"></div>
<!--会员编辑-->
<div id="user_edit">
	<input type="image" src='../assets/img/guanbi.png' onclick="cancel_shield()" style="position: absolute;left: 745px;top: 10px;width: 27px;height: 27px">
	<table class="table table-bordered " style="width: 600px;margin:0 auto;margin-top: 60px" id="table_edit">
	</table>
</div>
<!--会员新增-->
<div id="log_window">
	<input type="image" src='../assets/img/guanbi.png' onclick="cancel_shield()" style="position: absolute;left: 745px;top: 10px;width: 27px;height: 27px">
	<table class="table table-bordered " style="width: 600px;margin:0 auto;margin-top: 60px" id="user_add"></table>
</div>
<!--详情-->
<div id="user_info">
	<input type="image" src='../assets/img/guanbi.png' onclick="cancel_shield()" style="position: absolute;left: 745px;top: 10px;width: 27px;height: 27px">
	<table class="table table-bordered " style="width: 600px;margin:0 auto;margin-top: 60px" id="table_info"></table>
</div>
<!--查看照片-->
<div id="user_photo">
	<input type="image" src='../assets/img/guanbi.png' onclick="cancel_shield()" style="position: absolute;left: 745px;top: 10px;width: 27px;height: 27px">
	<div id="photo" style="text-align: center;margin-top: 60px"></div>
</div>
<div id="mytooltip"></div>

<div id="test1"><span>数据同步中，请稍后......</span></div>
</body>

</html>
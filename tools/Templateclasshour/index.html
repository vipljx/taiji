<!DOCTYPE html>
<html>

<head>
	<title></title>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="../Css/bootstrap.css" />
	<link rel="stylesheet" type="text/css" href="../Css/bootstrap-responsive.css" />
	<link rel="stylesheet" type="text/css" href="../Css/style.css" />
	<script type="text/javascript" src="../Js/jquery.js"></script>
	<script type="text/javascript" src="../Js/jquery-ui.js"></script>
	<script type="text/javascript" src="../Js/bootstrap.js"></script>
	<script type="text/javascript" src="../Js/ckform.js"></script>
	<script type="text/javascript" src="../Js/common.js"></script>
	<script type="text/javascript" src="../Js/js/laydate.js"></script>
	<script type="text/javascript" src="../Js/ui.js"></script>
	<script type="text/javascript" src="../Js/ursl.js"></script>
	<style type="text/css">
		body {
			padding-bottom: 40px;
		}

		@media (max-width: 980px) {
			/* 启用浮动导航栏文字 */
			.navbar-text.pull-right {
				float: none;
				padding-left: 5px;
				padding-right: 5px;
			}
		}

		#test {
			width: 100%;
			height: 100%;
			background-color: #000;
			position: absolute;
			top: 0;
			left: 0;
			z-index: 2;
			opacity: 0.3;
			/*兼容IE8及以下版本浏览器*/
			filter: alpha(opacity=30);
			display: none;
		}

		#user_div{
			width: 800px;
			height: 350px;
			padding-bottom: 50px;
			background-color: white;
			margin: auto;
			position: absolute;
			z-index: 3;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			display: none;
			overflow-y: scroll;
			/*border: 2px solid #b1d6e8;*/
		}
		#user_photo {
			width: 800px;
			height: 420px;
			background-color: white;
			margin: auto;
			position: absolute;
			z-index: 3;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			display: none;
			overflow-y: scroll;
			/*border: 2px solid #b1d6e8;*/
		}
		.theadColor th {
			background-color: #b1d6e8;
			/*color: #1976b0;*/
			font-weight: normal;
			text-align: center;
			height: 20px;
			line-height: 22px;

		}

		.theadColor th span {
			color: #1976b0;
		}

		#chaxun {
			margin-top: 10px;
		}

		#addnew1 {
			margin-top: 10px;
		}

		#rolename {
			position: relative;
			margin-top: 19px;
		}

		.theadColor td,
		.tableleft {
			/*background-color: #b1d6e8;*/
			/*color: #1976b0;*/
			/*font-weight:normal;*/
		}

		.theadColor td,.tableleft  span {
			color:#000;
			font-weight: bold;
		}


		#rolename {
			padding-right: 30px;
			background: url("../assets/img/fangdajing.png") no-repeat scroll right center transparent;
		}

		#test1 {
			width: 100%;
			height: 100%;
			background-color: #000;
			position: absolute;
			top: 0;
			left: 0;
			z-index: 2;
			opacity: 0.3;
			/*兼容IE8及以下版本浏览器*/
			filter: alpha(opacity=30);
			display: none;
		}
		.table>thead>tr>td:last-child{
			width: 25%;
		}
		.onclick{
			margin-left: 35px;
		}
		.onclick a{
			margin: 0;

		}
		.desc_cont{
			width: 160px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			position: relative
		}
		.desc_msg{
			position: absolute;
			display: none;
			text-align: left;
			z-index: 99;
		}

		.desc_title{
			width: 160px;
			text-align: left;
			background: #ffffff;
			border: 1px solid #CCCCCC;
			border-radius: 5px;
		}
	</style>
	<script type="text/javascript">
        var subpath="Templateclasshour";
        var page = 1;
        var count = 10;
        var maxpage = 0;
        var dataarr = [];
        var updateClassHour=[];
        var currentIndex = -1;
        var localhost = " ";
        var table, role, res;
        var fields = [];
        var delClassHour=[];
        var addable1,updateable1,delable1,authority,pms,enables;
        localhost = window.sessionStorage ? sessionStorage.getItem("lh") : Cookie.read("lh");

        var url1=urls;
        $(function() {
            $(document).tooltip();
        });

        //加载列表
        function init() {

            //localhost = window.sessionStorage ? sessionStorage.getItem("lh") : Cookie.read("lh");
            table = 1;
            var uname = window.sessionStorage ? sessionStorage.getItem("mgr") : Cookie.read("mgr");
            manager = jQuery.parseJSON(uname);
            mid = manager.mid;
            mgrid = manager.id;
            role = manager.type;

            pms = window.sessionStorage? sessionStorage.getItem("管 理 员"): Cookie.read("管 理 员");

            authority = jQuery.parseJSON(pms);
            addable1 = authority.addable;
            updateable1 = authority.updateable;
            delable1 = authority.delable;
            enables = authority.enable;
//                alert(authority)


            if (null == uname || undefined == uname) {
                parent.window.location = '../Public/login.html';
                return;
            }
            if (window.sessionStorage) {
                page = sessionStorage.getItem("Node_page");
            } else {
                page = Cookie.read("Node_page");
            }
            if (null == page)
                page = 1;
            document.getElementById('pagelab').value = page;

            //判断各浏览器的兼容性
            var Sys = {};
            var ua = navigator.userAgent.toLowerCase();
            var s;
            (s = ua.match(/msie ([\d.]+)/)) ? Sys.ie = s[1]:
                (s = ua.match(/firefox\/([\d.]+)/)) ? Sys.firefox = s[1] :
                    (s = ua.match(/chrome\/([\d.]+)/)) ? Sys.chrome = s[1] :
                        (s = ua.match(/opera.([\d.]+)/)) ? Sys.opera = s[1] :
                            (s = ua.match(/version\/([\d.]+).*safari/)) ? Sys.safari = s[1] : 0;
            if (Sys.ie) { //Js判断为IE浏览器
                alert('http://www.wangjinhai119.com' + Sys.ie);
                if (Sys.ie == '9.0') { //Js判断为IE 9
                } else if (Sys.ie == '8.0') { //Js判断为IE 8
                } else {}
            }
            if (Sys.firefox) { //Js判断为火狐(firefox)浏览器
                document.getElementById('pagelab').style.marginTop = '19px';
            }
            if (Sys.chrome) { //Js判断为谷歌chrome浏览器
                document.getElementById('pagelab').style.marginTop = '18px';
            }
            if (Sys.opera) { //Js判断为opera浏览器
                alert('http://www.wangjinhai119.com' + Sys.opera);
            }
            if (Sys.safari) { //Js判断为苹果safari浏览器
                document.getElementById('pagelab').style.marginTop = '9px';
            }
            initFields();
        }
        //动态表头
        function initFields() {
            //alert(3333)
            //alert(url1)
            var users=new Object();
            users.rid=role;
            users.smid=13;
            var datajson=JSON.stringify(users);
            $.ajax({
                type: "post",
                contentType: "application/x-www-form-urlencoded",
                url: "http://" + url1 + ":6078/backstagegetpermissionfieldbyridsmid",
                data:datajson,
                dataType:"json",
                success: function(data) {
                    data.permissionfieldmap.sort(function(a,b){
                        return a.smdid-b.smdid;
                    });
                    fields = [];
                    //console.log(data.permissionfieldmap);
                    for (var i = 0; i < data.permissionfieldmap.length; i++) {

                        if(data.permissionfieldmap[i].fieldname!=="state" && data.permissionfieldmap[i].fieldname!=="classhour"  && data.permissionfieldmap[i].fieldname!=="price"){
                            fields.push(data.permissionfieldmap[i]);
						}

                        //console.log(data.permissionfieldmap[i]);
                    }
                    var th = document.getElementById("tabhead");
                    while (th.cells.length > 0) {
                        th.deleteCell(0);
                    }
                    for (var i = 0; i < fields.length; i++) {
                        var headcell = th.insertCell(i);
                        headcell.innerHTML = "<th><span>" + fields[i].name + "</span></th>";
                    }
                    var headoptcell = th.insertCell(fields.length);
                    headoptcell.innerHTML = "<th><span>" + "操 作" + "</span></th>";
                    initTableData();
                },
                error: function(err) {
//						alert("err:" + err);
                }
            });
        }

        //公开课列表初始化
        function initTableData() {
            var obj=new Object();
            obj.page=page;
            obj.count=count;
            var datajson=JSON.stringify(obj);
            $.ajax({
                type: "post",
                contentType:"application/x-www-form-urlencoded",
                data:datajson,
                dataType:"json",
                url:"http://" + url1 + ":6078/backstagegetcoursemoudle",
                success: function(data) {
                    //console.log(data);
                    if(data.respVo.resultCode==0) {
						//设置排序
						data.coursemoudlemap.sort(function sortId(a,b){
							return b.id-a.id
						});
						//console.log(data.coursemoudlemap);
						var table1 = document.getElementById('tbl');
						dataarr = [];
						while (table1.rows.length > 1) {
							table1.deleteRow(1);
						}
						if (window.sessionStorage ) {
                            delClassHour = JSON.parse(sessionStorage.getItem("delClassHour")?sessionStorage.getItem("delClassHour"):"[]");
							updateClassHour = JSON.parse(sessionStorage.getItem("updateClassHour")?sessionStorage.getItem("updateClassHour"):"[]");
						} else {
                            delClassHour = JSON.parse(Cookie.read("delClassHour")?sessionStorage.getItem("delClassHour"):"[]");
							updateClassHour = JSON.parse(Cookie.read("updateClassHour")?sessionStorage.getItem("updateClassHour"):"[]");
						}
						//console.log(data.coursemap);
						for (var i = 0; i < data.coursemoudlemap.length; i++) {
							if(updateClassHour.length>0) {
								for (var j = 0; j < updateClassHour.length; j++) {
									if (data.coursemoudlemap[i].id == updateClassHour[j].id) {
										data.coursemoudlemap[i] = updateClassHour[j];
									}
								}
							}

							dataarr.push(data.coursemoudlemap[i]);
                            if(delClassHour.indexOf(data.coursemoudlemap[i].id)==-1) {
                                var row = table1.insertRow(table1.rows.length);
                                for (var k = 0; k < fields.length; k++) {
                                    var cell = row.insertCell(k);
                                    if(fields[k].fieldname=="imgurl"){
                                        cell.innerHTML = `<a onclick="handleClick(${i})" style="cursor: pointer">点击查看</a>`;
                                    }else if(fields[k].fieldname=="weburl"){
                                        cell.innerHTML = `<a target="_blank" href="${dataarr[i][fields[k].fieldname]?dataarr[i][fields[k].fieldname]:""}" style="width: 160px; display: inline-block; word-break: break-all; overflow:hidden;">${dataarr[i][fields[k].fieldname]?dataarr[i][fields[k].fieldname]:""}</a>`;
									}else if(fields[k].fieldname == "description"){
                                        cell.innerHTML = `<div class="desc_cont" id="description${i}">${dataarr[i][fields[k].fieldname]}</div>
													  <div class="desc_msg">
													 	<p class="desc_title">${dataarr[i][fields[k].fieldname]}</p>
													  </div>`;
                                        cell.style.width="160px";
                                        $("#description"+i).mouseenter(function(){
                                            //console.log($(this).next());
                                            $(this).next().css("display","block")
                                        });
                                        $("#description"+i).mouseleave(function(){
                                            $(this).next().css("display","none")
                                        })
                                    }else{
                                        cell.innerHTML = dataarr[i][fields[k].fieldname];
									}

                                }
                                var optcell = row.insertCell(fields.length);
                                optcell.innerHTML = "<input type='image' src='../assets/img/bianji.png' id='bianji" + i + "' value='' onclick='edit(" + data.coursemoudlemap[i].id + "," + i + ")'>" +
                                    "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/shanchu.png' id='shanchu" + i + "'  value='' onclick='del(" + data.coursemoudlemap[i].id + "," + i + ")'>";

                            }

						//console.log(dataarr);
                    	}
                        maxpage = Math.ceil(data.respVo.resultDesc / count);
                        //设置分页
						var first=$(".page>div>div:nth-child(1)");
						var prev=$(".page>div>div:nth-child(2)");
						var next=$(".page>div>div:nth-child(3)");
						var last=$(".page>div>div:nth-child(4)");
						if(page>1){
							first.attr("class","blue")
						}else{
							first.attr("class","gray")
						}
						if(page>1){
							prev.attr("class","blue")
						}else{
							prev.attr("class","gray")
						}
						if(page<maxpage){
							next.attr("class","blue")
						}else{
							next.attr("class","gray")
						}
						if(page<maxpage){
							last.attr("class","blue")
						}else{
							last.attr("class","gray")
						}
                    }else{
                        //alert(data.respVo.resultDesc);
                    }
                },
                error: function(err) {
//						alert("err:" + err);
                }
            });

        }

        //图片上传
        function upload() {
            var formData = new FormData();
            var ifimgurl=document.getElementById("imgurltext");
            if(ifimgurl){
                formData.append("file", document.getElementById("imgurltext").files[0]);
            }else{
                formData.append("file", document.getElementById("imgurltxt").files[0]);
            }
            //console.log(document.getElementById("imgurltext").files[0]);
            $.ajax({
                url: "http://" + localhost + ":8080/taiji.tools/FileServlet?dir="+subpath,
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function(data) {
                },
                error: function() {
                    mizhu.alert('', '上传失败！','iconfont-close');
                }
            });
        }

        //查看照片
        function handleClick(idx){
            //console.log(dataarr[idx].imgurl);
            var s = document.getElementById("test");
            s.style.display = "block";
            var l = document.getElementById("user_photo");
            l.style.display = "block";
            var photo = document.getElementById("photo");
            if(dataarr[idx].imgurl){
                photo.innerHTML=`<img src="/taiji.tools/upload/${dataarr[idx].imgurl}"/>`;
            }else{
                photo.innerHTML=``;
            }


        }

        //重新上传
        function reload(){
            document.getElementById("imgurltxt").value="";
            document.getElementById("imgurl2").style.display="none";
            document.getElementById("imgurl1").style.display="";
        }

        //公共列表
        function initTables(idx){
            for (var i = 1; i < fields.length; i++) {
                var row = user_table.insertRow(user_table.rows.length);
                if(fields[i].fieldname=="imgurl"){
                    if(idx>=0){
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td>
													<div style="width: 95%; margin: 0 auto; display: none" id="imgurl1"><input type="file" id="${fields[i].fieldname}text" class="txt" name="moduletitle" style="border-radius: 0px; float: left"  /><div style="clear: both; height: 0px;"></div></div>
													<div style="width: 95%; margin: 0 auto; position: relative; top: 5px; " id="imgurl2"><input type="text" id="${fields[i].fieldname}txt" class="txt" name="moduletitle" style="border-radius: 0px; float: left" value="${dataarr[idx][fields[i].fieldname] ?dataarr[idx][fields[i].fieldname]:''}" disabled="disabled" /><input type="button" value="重新上传" onclick="reload()" style="float: right"><div style="clear: both; height: 0px;"></div></div>
												    <span id="${fields[i].fieldname}text_info"></span>
												</td>`;
                    }else{
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td >
								<div style="width: 95%; margin: 0 auto;"><input type="file" id="${fields[i].fieldname}text" class="txt" name="moduletitle" style="border-radius: 0px; float: left" value="" /><div style="clear: both; height: 0px;"></div></div>
								<span id="${fields[i].fieldname}text_info"></span>
							</td>`;
                    }

                }else{
                    row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td style="padding-top: 18px">
						<input type="text" id="${fields[i].fieldname}text" class="txt" name="moduletitle" style="border-radius: 0px;width: 95%" value="${idx>=0?dataarr[idx][fields[i].fieldname]?dataarr[idx][fields[i].fieldname]:'':''}" /><br />
						<span id="${fields[i].fieldname}text_info"></span>
						</td>`;
				}


            }
        }

        //新增公开课
        function add1() {

            if(addable1 == 0){
                return;
            }
            var s = document.getElementById("test");
            s.style.display = "block";
            var l = document.getElementById("user_div");
            l.style.display = "block";
            var user_table = document.getElementById('user_table');
            while (user_table.rows.length > 0) {
                user_table.deleteRow(0);
            }
            currentIndex = -1;
            initTables(currentIndex);
            var optrow = user_table.insertRow(user_table.rows.length);
            optrow.innerHTML = `<tr>
					<td class="tableleft"></td>
					<td>
						<a  onclick="onSavebtnClickHandler()" class="save">保 存</a>
					</td>
				</tr>`;
        }


        //编辑公开课
        function edit(id,idx) {

            if(updateable1 == 0){
                return;
            }
            var s = document.getElementById("test");
            s.style.display = "block";
            var l = document.getElementById("user_div");
            l.style.display = "block";
            var user_table = document.getElementById('user_table');
            while (user_table.rows.length > 0) {
                user_table.deleteRow(0);
            }
            currentIndex = idx;
            initTables(idx);
            var optrow = user_table.insertRow(user_table.rows.length);
            optrow.innerHTML = `<tr>
										<td class="tableleft"></td>
										<td colspan="3">
											<a  onclick="onSavebtnClickHandler(${id})" class="save">保 存</a>
										</td>
										</tr>`;
        }


        //删除公开课
        function del(id,idx) {
            if(delable1 == 0){
                return;
            }
            if (confirm("确定要删除吗？")) {
                var obj=new Object();
                obj.id=id;
                var datajson=JSON.stringify(obj);
                // console.log(datajson);
                $.ajax({
                    type: "post",
                    contentType:"application/x-www-form-urlencoded",
                    dataType:"json",
                    data:datajson,
                    url:"http://" + url1 + ":6078/backstagedelcoursemoudleservice",
                    success: function(data) {
                        delClassHour = JSON.parse(sessionStorage.getItem("delClassHour")?sessionStorage.getItem("delClassHour"):"[]");
                        delClassHour.push(id);
                        if (window.sessionStorage) {
                            sessionStorage.setItem("delClassHour", JSON.stringify(delClassHour));
                        } else {
                            Cookie.write("delClassHour", JSON.stringify(delClassHour));
                        }
                        init();
                    },
                    error: function(err) {
                        //mizhu.alert('','err:'+ err,'iconfont-close');
                    }
                });
            }
        }


        //验证
        function checknametext(){
            var nametext = document.getElementById("nametext");
            var nametext_info = document.getElementById("nametext_info");
            if (nametext.value == "" ) {
                nametext_info.innerHTML = "该字段不能为空";
                nametext.style.border = "1px solid red";
                nametext_info.style.color = "red";
                return false;
            }
            else {
                nametext_info.innerHTML = "";
                nametext.style.border = "";
                return true;
            }

        }

        function checkdescriptiontext(){
            var descriptiontext = document.getElementById("descriptiontext");
            var descriptiontext_info = document.getElementById("descriptiontext_info");
            if (descriptiontext.value == "" ) {
                descriptiontext_info.innerHTML = "该字段不能为空";
                descriptiontext.style.border = "1px solid red";
                descriptiontext_info.style.color = "red";
                return false;
            }
            else {
                descriptiontext_info.innerHTML = "";
                descriptiontext.style.border = "";
                return true;
            }

        }
        function checkimgurltext(){
            var imgurltext = document.getElementById("imgurltext");
            var imgurltext_info = document.getElementById("imgurltext_info");
            if (!imgurltext.files[0]) {
                imgurltext_info.innerHTML = "该字段不能为空";
                imgurltext_info.style.color = "red";
                return false;
            }else{
                imgurltext_info.innerHTML = "";
                imgurltext.style.border = "";
                return true;
            }
        }
        function checkimgurltxt(){
            var imgurltxt = document.getElementById("imgurltxt");
            var imgurltext = document.getElementById("imgurltext");
            var imgurltext_info = document.getElementById("imgurltext_info");
            if (!imgurltext.files[0]) {
                if(imgurltxt.value==""){
                    imgurltext_info.innerHTML = "该字段不能为空";
                    imgurltext_info.style.color = "red";
                    return false;
                }else{
                    imgurltext_info.innerHTML = "";
                    imgurltext.style.border = "";
                    return true;
                }
            }else{
                imgurltext_info.innerHTML = "";
                imgurltext.style.border = "";
                return true;
            }
        }

        //保存添加与修改的公开课
        function onSavebtnClickHandler(id,requrl = "") {
            if(checknametext()&&checkdescriptiontext()){
                var datajson;
                if (requrl == undefined || requrl.length == 0) {
                    if (currentIndex >= 0) {
                        if(checkimgurltxt()){
                            var url = "http://" + url1 + ":6078/backstageupdatecoursemoudleservice";
                            var obj = new Object();
                            obj.id = parseInt(id);
                            for (var i = 1; i < fields.length; i++) {
                                if(fields[i].fieldname=="imgurl"){
                                    var ifimgurl=document.getElementById(fields[i].fieldname+'text').files[0];
                                    //console.log(ifimgurl);
                                    if(ifimgurl){
                                        obj[fields[i].fieldname]="/" + subpath + "/" + document.getElementById(fields[i].fieldname+'text').files[0].name;
                                    }else{
                                        obj[fields[i].fieldname]=document.getElementById(fields[i].fieldname+'txt').value;
                                    }
                                }else{
                                    obj[fields[i].fieldname]=document.getElementById(fields[i].fieldname+'text').value;
                                }
                            }
                            datajson = JSON.stringify(obj);
                            console.log(datajson);
                            save();
                        }else{
                            mizhu.alert('', '请正确完善信息','iconfont-close');
						}


                    } else {
                        if(checkimgurltext()){
                            var url = "http://" + url1 + ":6078/backstageaddcoursemoudleservice";
                            var obj = new Object();
                            for (var i = 1; i < fields.length; i++) {
                                if(fields[i].fieldname=="imgurl"){
                                    obj[fields[i].fieldname] ="/" + subpath + "/" + document.getElementById(fields[i].fieldname+'text').files[0].name;
                                }else{
                                    obj[fields[i].fieldname] = document.getElementById(fields[i].fieldname + "text").value;
                                }
                            }
                            datajson = JSON.stringify(obj);
                            //console.log(datajson);
                            save();
                        }else{
                            mizhu.alert('', '请正确完善信息','iconfont-close');

                        }



                    }
                    function save()	{
                        $.ajax({
                            type: "post",
                            contentType: "application/x-www-form-urlencoded",
                            data: datajson,
                            dataType: "json",
                            url: url,
                            success: function (data) {
                                 //console.log(data);
                                //console.log(currentIndex);
                                if (currentIndex >= 0) {
                                    if(data.respVo.resultCode<0){
                                        mizhu.alert('',data.respVo.resultDesc,'iconfont-close');
                                        return;
                                    }else{
                                        datajson=JSON.parse(datajson);
                                        if (window.sessionStorage) {
                                            updateClassHour = JSON.parse(sessionStorage.getItem("updateClassHour")?sessionStorage.getItem("updateClassHour"):"[]");
                                            if(updateClassHour.length>0) {
                                                var len=0;
                                                for (var j = 0; j < updateClassHour.length; j++) {
                                                    //console.log(updateClassHour[j].id+"b");
                                                    if (datajson.id == updateClassHour[j].id) {
                                                        len++;
                                                        updateClassHour[j]=datajson;
                                                    }
                                                }
                                                if(len==0){
                                                    updateClassHour.push(datajson);
                                                }
                                            }else{
                                                updateClassHour.push(datajson);
                                            }
                                            sessionStorage.setItem("updateClassHour", JSON.stringify(updateClassHour));
                                        } else {
                                            updateClassHour = JSON.parse(Cookie.read("updateClassHour")?Cookie.read("updateClassHour"):"[]");
                                            if(updateClassHour.length>0) {
                                                var len=0;
                                                for (var j = 0; j < updateClassHour.length; j++) {
                                                    if (datajson.id == updateClassHour[j].id) {
                                                        len++;
                                                        updateClassHour[j]=datajson;
                                                    }
                                                }
                                                if(len==0){
                                                    updateClassHour.push(datajson);
                                                }
                                            }else{
                                                updateClassHour.push(datajson);
                                            }
                                            Cookie.write("updateClassHour", JSON.stringify(updateClassHour));
                                        }
                                        upload();
                                        mizhu.alert('', '修改成功','iconfont-gou');
                                        init();
                                        cancel_shield();
                                    }
                                }
                                else {
                                    if(data.respVo.resultCode<0){
                                        mizhu.alert('',data.respVo.resultDesc,'iconfont-close');
                                        return;
                                    }else{
                                        upload();
                                        mizhu.alert('', '添加成功','iconfont-gou');
                                        init();
                                        cancel_shield();
                                    }

                                }
                            },
                            error: function (err) {
                                mizhu.alert('','保存失败','iconfont-close');
                                cancel_shield();
                            }
                        });
                    }

                }
            }else{
                mizhu.alert('', '请正确完善信息','iconfont-close');
            }

        }






        //关闭弹出的div
        function cancel_shield() {
            var s = document.getElementById("test");
            s.style.display = "none";
            var e = document.getElementById("user_div");
            e.style.display = "none";
            var p = document.getElementById("user_photo");
            p.style.display = "none";
            var m = document.getElementById("mytooltip");
            m.style.display = "none";
        }




        //查询
        function inquiry() {
            page = 1;
            document.getElementById('pagelab').value = page;
            if (window.sessionStorage) {
                sessionStorage.setItem("Node_page", page);
            } else {
                Cookie.write("Node_page", page);
            }
            $.ajax({
                type: "get",
                contentType: "application/xml",
                url: "http://" + localhost + ":8080/fkds1.5.tools/systemManager/getManagerByName.action?name=" + document.getElementById('rolename').value + "&page=1&count=10",
                success: function(data) {
                    res = jQuery.parseJSON(data);
                    var table1 = document.getElementById('tbl');
                    while (table1.rows.length > 1) {
                        table1.deleteRow(1);
                    }
                    dataarr = [];
                    for (var i = 0; i < res.res.length; i++) {
                        dataarr.push(res.res[i]);
                        var row = table1.insertRow(table1.rows.length);
                        for (var k = 0; k < fields.length; k++) {
                            var cell = row.insertCell(k);
                            cell.innerHTML = res.res[i][fields[k].fieldname];
                        }
                        var optcell = row.insertCell(fields.length);
                        optcell.innerHTML = "<input type='image' src='../assets/img/bianji.png' id='bianji"+i+"' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='edit(" + i + ")'>" +
                            "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/shanchu.png' id='shanchu"+i+"' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='del(" + res.res[i].id + "," + table1.rows.length + ")'>";
                        if (res.res[i].id + "" == delid + "") {
                            optcell.innerHTML = '已删除同步中...';
                        }
                    }
                },
                error: function(err) {
//						alert("err:" + err);
                }
            });
        }

        //分页
        function first(){
            if(document.getElementById("pagelab").value==1){
                mizhu.alert('', '当前已经为第一页!','iconfont-close');
            }
            else{
                initTable(1,true);
            }

        }
        function last(){

            if(document.getElementById("pagelab").value==maxpage){
                mizhu.alert('', '当前已经为最后页!','iconfont-close');
            }
            else{
                initTable(parseInt(maxpage),true);
            }

        }

        function initTable(step, flag = false) {
            initFields();
            step = parseInt(step);
            var p = parseInt(page) + parseInt(step);
            if (flag) {
                if (step < 1 || step > maxpage) {
                    mizhu.alert('', '页码超标','iconfont-close');
                    return;
                }
                page = step;
            } else {
                page = p;
                if (page < 1 || page > maxpage) {
                    page -= step;
                    return;
                }
            }

            var obj=new Object();
            obj.page=page;
            obj.count=count;
            var datajson=JSON.stringify(obj);
            $.ajax({
                type: "post",
                contentType:"application/x-www-form-urlencoded",
                data:datajson,
                dataType:"json",
                url:"http://" + url1 + ":6078/backstagegetcoursemoudle",
                success: function(data) {
                    //设置排序
                    data.coursemoudlemap.sort(function sortId(a,b){
                        return b.id-a.id
                    });
                    //console.log(data.coursemoudlemap);
                    var table1 = document.getElementById('tbl');
                    dataarr = [];
                    while (table1.rows.length > 1) {
                        table1.deleteRow(1);
                    }
                    if (window.sessionStorage ) {
                        delClassHour = JSON.parse(sessionStorage.getItem("delClassHour")?sessionStorage.getItem("delClassHour"):"[]");
                        updateClassHour = JSON.parse(sessionStorage.getItem("updateClassHour")?sessionStorage.getItem("updateClassHour"):"[]");
                    } else {
                        delClassHour = JSON.parse(Cookie.read("delClassHour")?sessionStorage.getItem("delClassHour"):"[]");
                        updateClassHour = JSON.parse(Cookie.read("updateClassHour")?sessionStorage.getItem("updateClassHour"):"[]");
                    }
                    //console.log(data.coursemap);
                    for (var i = 0; i < data.coursemoudlemap.length; i++) {
                        if(updateClassHour.length>0) {
                            for (var j = 0; j < updateClassHour.length; j++) {
                                if (data.coursemoudlemap[i].id == updateClassHour[j].id) {
                                    data.coursemoudlemap[i] = updateClassHour[j];
                                }
                            }
                        }

                        dataarr.push(data.coursemoudlemap[i]);
                        if(delClassHour.indexOf(data.coursemoudlemap[i].id)==-1) {
                            var row = table1.insertRow(table1.rows.length);
                            for (var k = 0; k < fields.length; k++) {
                                var cell = row.insertCell(k);
                                if(fields[k].fieldname=="imgurl"){
                                    cell.innerHTML = `<a onclick="handleClick(${i})" style="cursor: pointer">点击查看</a>`;
                                }else if(fields[k].fieldname=="weburl"){
                                    cell.innerHTML = `<a target="_blank" href="${dataarr[i][fields[k].fieldname]?dataarr[i][fields[k].fieldname]:""}" style="width: 160px; display: inline-block; word-break: break-all; overflow:hidden;">${dataarr[i][fields[k].fieldname]?dataarr[i][fields[k].fieldname]:""}</a>`;
                                }else{
                                    cell.innerHTML = dataarr[i][fields[k].fieldname];
                                }

                            }
                            var optcell = row.insertCell(fields.length);
                            optcell.innerHTML = "<input type='image' src='../assets/img/bianji.png' id='bianji" + i + "' value='' onclick='edit(" + data.coursemoudlemap[i].id + "," + i + ")'>" +
                                "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/shanchu.png' id='shanchu" + i + "'  value='' onclick='del(" + data.coursemoudlemap[i].id + "," + i + ")'>";

                        }

                        //console.log(dataarr);
                    }
                    maxpage = Math.ceil(data.respVo.resultDesc / count);
                    document.getElementById('pagelab').value = page;

                },
                error: function(err) {
//						alert("err:" + err);
                }
            });
        }

        function pageKeyUpHandler(evt) {
            if (evt.keyCode == 13) {
                initTable(parseInt(document.getElementById("pagelab").value), true);
            }
        }
        function msg(idx){
//            console.log(idx);
//            console.log(dataarr);
            window.location ="msg.html";
            if (window.sessionStorage) {
                sessionStorage.setItem("course", JSON.stringify(dataarr[idx]));

            } else {
                Cookie.write("course", dataarr[idx]);

            }
        }

        //权限增删改
        function isdisadd(obj) {

            var idstr = obj.id;

            if (addable1 == 0 && idstr.indexOf("add")>=0){
                document.getElementById(idstr).disabled = 'disabled';
                document.getElementById(idstr).style.cursor = "not-allowed";
            }

            if (updateable1 == 0 && idstr.indexOf("bian")>=0){
                document.getElementById(idstr).disabled = 'disabled';
                document.getElementById(idstr).style.cursor = "not-allowed";
            }

            if (delable1 == 0 && idstr.indexOf("shan")>=0){
                document.getElementById(idstr).disabled = 'disabled';
                document.getElementById(idstr).style.cursor = "not-allowed";
            }
        }

        function isdisout(obj) {
            var idstr = obj.id;
            document.getElementById(idstr).disabled = false;
            document.getElementById(idstr).style.cursor = "pointer";
        }

	</script>
</head>
<body onload="init()">
<div class="onclick">
	<a id="addnew1"  onclick="add1()" class="add2">新  增</a>
</div>

<!--<a  id="qingkong" onclick="qingkong()"><image style="margin-top: 10px" src="../assets/img/xinzeng.png"></image></a>-->
<table class="table table-hover definewidth m10" id="tbl">
	<thead id="thead">
	<tr id="tabhead" class="theadColor">
	</tr>
	</thead>
</table>


<div class="inline pull-right page">
	<div class="first" onclick="first()">第一页</div>
	<div class="prev" onclick="initTable(-1)">上一页</div>
	<div class="next" onclick="initTable(1)">下一页</div>
	<div class="last" onclick="last()">最后一页</div>
	<div class="clearfix"></div>
	<input type="hidden" id="pagelab" style="width: 50px;height:22px;overflow:hidden;margin-right: 5px;text-align: center;border-radius: 0px" onkeyup="pageKeyUpHandler(event)">
</div>

<!--//弹出遮罩-->
<div id="test"></div>

<!--会员新增与编辑-->
<div id="user_div">
	<input type="image" src='../assets/img/guanbi.png' onclick="cancel_shield()" style="position: absolute;left: 745px;top: 10px;width: 27px;height: 27px">
	<table class="table table-bordered " style="width: 600px;margin:0 auto;margin-top: 60px" id="user_table">
	</table>
</div>

<!--查看照片-->
<div id="user_photo">
	<input type="image" src='../assets/img/guanbi.png' onclick="cancel_shield()" style="position: absolute;left: 745px;top: 10px;width: 27px;height: 27px">
	<div id="photo" style="text-align: center; margin-top: 60px;"></div>
</div>

<div id="mytooltip"></div>

<div id="test1"><span>数据同步中，请稍后......</span></div>
</body>

</html>
<!DOCTYPE html>
<html>

	<head>
		<title></title>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="../Css/bootstrap.css" />
		<link rel="stylesheet" type="text/css" href="../Css/bootstrap-responsive.css" />
		<link rel="stylesheet" type="text/css" href="../Css/style.css" />
		<script type="text/javascript" src="../Js/jquery.js"></script>
		<script type="text/javascript" src="../Js/jquery-ui.js"></script>
		<script type="text/javascript" src="../Js/bootstrap.js"></script>
		<script type="text/javascript" src="../Js/ckform.js"></script>
		<script type="text/javascript" src="../Js/common.js"></script>
		<script type="text/javascript" src="../Js/js/laydate.js"></script>
		<script type="text/javascript" src="../Js/ui.js"></script>
		<script type="text/javascript" src="../Js/ursl.js"></script>
		<style type="text/css">
			body {
				padding-bottom: 40px;
			}

			@media (max-width: 980px) {
				/* 启用浮动导航栏文字 */
				.navbar-text.pull-right {
					float: none;
					padding-left: 5px;
					padding-right: 5px;
				}
			}

			#test {
				width: 100%;
				height: 100%;
				background-color: #000;
				position: absolute;
				top: 0;
				left: 0;
				z-index: 2;
				opacity: 0.3;
				/*兼容IE8及以下版本浏览器*/
				filter: alpha(opacity=30);
				display: none;
			}

			#user_div{
				width: 800px;
				height: 500px;
				padding-bottom: 50px;
				background-color: white;
				margin: auto;
				position: absolute;
				z-index: 3;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
				display: none;
				overflow-y: scroll;
				/*border: 2px solid #b1d6e8;*/
			}
			.theadColor th {
				background-color: #b1d6e8;
				/*color: #1976b0;*/
				font-weight: normal;
				text-align: center;
				height: 20px;
				line-height: 22px;

			}
			
			.theadColor th span {
				color: #1976b0;
			}
			
			#chaxun {
				margin-top: 10px;
			}
			
			#addnew1 {
				margin-top: 10px;
			}
			
			#rolename {
				position: relative;
				margin-top: 19px;
			}
			
			.theadColor td,
			.tableleft {
				/*background-color: #b1d6e8;*/
				/*color: #1976b0;*/
				/*font-weight:normal;*/
			}

			.theadColor td,.tableleft  span {
				color:#000;
				font-weight: bold;
			}

			
			#rolename {
				padding-right: 30px;
				background: url("../assets/img/fangdajing.png") no-repeat scroll right center transparent;
			}
			
			#test1 {
				width: 100%;
				height: 100%;
				background-color: #000;
				position: absolute;
				top: 0;
				left: 0;
				z-index: 2;
				opacity: 0.3;
				/*兼容IE8及以下版本浏览器*/
				filter: alpha(opacity=30);
				display: none;
			}
			.table>thead>tr>td:last-child{
				width: 25%;
			}
			.onclick{
				margin-left: 35px;
			}
			.onclick a{
				margin: 0;

			}
		</style>
		<script type="text/javascript">

			var page = 1;
			var count = 10;
			var maxpage = 0;
			var dataarr = [];
			var updateCourseannounce=[];
			var currentIndex = -1;
			var localhost = " ";
			var table, role, res;
			var fields = [];
            //			所有教练
            var allcoach=[];
            //          关联公开课教练
            var coursecoach=[];
            //			所有拳馆
            var freevenue=[];
            var usercoursetype=[{"1":"正常"},{"2":"企业"}];
			var addable1,updateable1,delable1,authority,pms,enables;
				localhost = window.sessionStorage ? sessionStorage.getItem("lh") : Cookie.read("lh");

            var url1=urls;
			$(function() {
				$(document).tooltip();
			});

			//加载列表
			function init() {

			//localhost = window.sessionStorage ? sessionStorage.getItem("lh") : Cookie.read("lh");
				table = 1;
				var uname = window.sessionStorage ? sessionStorage.getItem("mgr") : Cookie.read("mgr");
				manager = jQuery.parseJSON(uname);
				mid = manager.mid;
				mgrid = manager.id;
				role = manager.type;

				pms = window.sessionStorage? sessionStorage.getItem("管 理 员"): Cookie.read("管 理 员");

	            authority = jQuery.parseJSON(pms);
	            addable1 = authority.addable;
	            updateable1 = authority.updateable;
	            delable1 = authority.delable;
                enables = authority.enable;
//                alert(authority)

				
				if (null == uname || undefined == uname) {
					parent.window.location = '../Public/login.html';
					return;
				}
				if (window.sessionStorage) {
					page = sessionStorage.getItem("Node_page");
				} else {
					page = Cookie.read("Node_page");
				}
				if (null == page)
					page = 1;
				document.getElementById('pagelab').value = page;

				//判断各浏览器的兼容性
				var Sys = {};
				var ua = navigator.userAgent.toLowerCase();
				var s;
				(s = ua.match(/msie ([\d.]+)/)) ? Sys.ie = s[1]:
					(s = ua.match(/firefox\/([\d.]+)/)) ? Sys.firefox = s[1] :
					(s = ua.match(/chrome\/([\d.]+)/)) ? Sys.chrome = s[1] :
					(s = ua.match(/opera.([\d.]+)/)) ? Sys.opera = s[1] :
					(s = ua.match(/version\/([\d.]+).*safari/)) ? Sys.safari = s[1] : 0;
				if (Sys.ie) { //Js判断为IE浏览器
					alert('http://www.wangjinhai119.com' + Sys.ie);
					if (Sys.ie == '9.0') { //Js判断为IE 9
					} else if (Sys.ie == '8.0') { //Js判断为IE 8
					} else {}
				}
				if (Sys.firefox) { //Js判断为火狐(firefox)浏览器
					document.getElementById('pagelab').style.marginTop = '19px';
				}
				if (Sys.chrome) { //Js判断为谷歌chrome浏览器
					document.getElementById('pagelab').style.marginTop = '18px';
				}
				if (Sys.opera) { //Js判断为opera浏览器
					alert('http://www.wangjinhai119.com' + Sys.opera);
				}
				if (Sys.safari) { //Js判断为苹果safari浏览器
					document.getElementById('pagelab').style.marginTop = '9px';
				}
				initFields();
			}
            //动态表头
            function initFields() {
                //alert(url1)
                var users=new Object();
                users.rid=role;
                users.smid=9;
                var datajson=JSON.stringify(users);
                //console.log(datajson);
                $.ajax({
                    type: "post",
                    contentType: "application/x-www-form-urlencoded",
                    url: "http://" + url1 + ":6078/backstagegetpermissionfieldbyridsmid",
                    data:datajson,
                    dataType:"json",
                    success: function(data) {
                        //console.log(data);
                        data.permissionfieldmap.sort(function(a,b){
                            return a.smdid-b.smdid;
                        })
                        fields = [];
                        for (var i = 0; i < data.permissionfieldmap.length; i++) {
                            if(data.permissionfieldmap[i].fieldname!=="state"  && data.permissionfieldmap[i].fieldname!=="classhour"  && data.permissionfieldmap[i].fieldname!=="price"){
                                fields.push(data.permissionfieldmap[i]);
                            }
                            //console.log(data.permissionfieldmap[i]);
                        }
                        var th = document.getElementById("tabhead");
                        while (th.cells.length > 0) {
                            th.deleteCell(0);
                        }
                        for (var i = 0; i < fields.length; i++) {
                            var headcell = th.insertCell(i);
                            headcell.innerHTML = "<th><span>" + fields[i].name + "</span></th>";
                        }
                        var headoptcell = th.insertCell(fields.length);
                        headoptcell.innerHTML = "<th><span>" + "操 作" + "</span></th>";
                        initTableData();
                        initallvenue();
                        initallcoach();
                        initcoursecoach();
                    },
                    error: function(err) {
//						alert("err:" + err);
                    }
                });
            }
            //获取所有拳馆
            function initallvenue(){
                var obj=new Object();
                obj.vid=manager.vid;
                obj.page=page;
                obj.count=999999;
                var datajson=JSON.stringify(obj);
                $.ajax({
                    type: "post",
                    contentType:"application/x-www-form-urlencoded",
                    data:datajson,
                    dataType:"json",
                    url:"http://" + url1 + ":6078/backstagegetvenue",
                    success: function(data) {
                        data.VenueMap.sort(function(a,b){
                            return a.id-b.id;
                        });
                       // console.log(data.VenueMap);
                        freevenue=[];
                        if(data.respVo.resultCode=="0"){
                            //console.log(data);
                            for(var i=0;i<data.VenueMap.length;i++){
                                    freevenue.push(data.VenueMap[i]);
                            }
                        }else{
                            freevenue.length=0;
                        }

                    },
                    error: function(err) {
//						alert("err:" + err);
                    }
                });
            }
            //获取所有教练
            function initallcoach(){
                var obj=new Object();
                obj.vid=manager.vid;
                var datajson=JSON.stringify(obj);
                $.ajax({
                    type: "post",
                    contentType:"application/x-www-form-urlencoded",
                    data:datajson,
                    dataType:"json",
                    url:"http://" + url1 + ":6078/backstagegetallcoach",
                    success: function(data) {
                        allcoach=[];
                        if(data.respVo.resultCode=="0"){
                            //console.log(data);
                            for(var i=0;i<data.UserMap.length;i++){
                                allcoach.push(data.UserMap[i]);
                            }
                        }else{
                            allcoach.length=0;
                        }


                    },
                    error: function(err) {
//						alert("err:" + err);
                    }
                });
            }
            //获取关联预告课教练
            function initcoursecoach(){
                var obj=new Object();
                var datajson=JSON.stringify(obj);
                $.ajax({
                    type: "post",
                    contentType:"application/x-www-form-urlencoded",
                    data:datajson,
                    dataType:"json",
                    url:"http://" + url1 + ":6078/backstagegetcoursecoach",
                    success: function(data) {
                        //console.log(data);
                        coursecoach=[];
                        if(data.respVo.resultCode=="0"){
                            //console.log(data);
                            for(var i=0;i<data.usercoursecoachmap.length;i++){
                                coursecoach.push(data.usercoursecoachmap[i]);
                            }
                        }else{
                            coursecoach.length=0;
                        }


                    },
                    error: function(err) {
//						alert("err:" + err);
                    }
                });
            }
			//预告课列表初始化
			function initTableData() {
				var obj=new Object();
                obj.vid=manager.vid;
				obj.page=page;
				obj.count=count;
                var datajson=JSON.stringify(obj);
                //console.log(datajson);
				$.ajax({
                    type: "post",
                    contentType:"application/x-www-form-urlencoded",
                    data:datajson,
                    dataType:"json",
                    url:"http://" + url1 + ":6078/backstagegetcourseannounce",
					success: function(data) {
						//console.log(data);
                        var table1 = document.getElementById('tbl');
                        dataarr = [];
                        while (table1.rows.length > 1) {
                            table1.deleteRow(1);
                        }
                        if(data.respVo.resultCode==0) {
							//设置排序
							data.courseannouncemap.sort(function sortId(a,b){
								return b.id-a.id
							});
							//console.log(data.courseannouncemap);
							if (window.sessionStorage ) {
								updateCourseannounce = JSON.parse(sessionStorage.getItem("updateCourseannounce")?sessionStorage.getItem("updateCourseannounce"):"[]");
							} else {
								updateCourseannounce = JSON.parse(Cookie.read("updateCourseannounce")?sessionStorage.getItem("updateCourseannounce"):"[]");
							}
							//console.log(updateCourseannounce);
							for (var i = 0; i < data.courseannouncemap.length; i++) {
								if(updateCourseannounce.length>0) {
									for (var j = 0; j < updateCourseannounce.length; j++) {
										if (data.courseannouncemap[i].id == updateCourseannounce[j].id) {
											data.courseannouncemap[i] = updateCourseannounce[j];
										}
									}
								}
								dataarr.push(data.courseannouncemap[i]);
                                if(data.courseannouncemap[i].state!==-1) {
                                    var row = table1.insertRow(table1.rows.length);
                                    for (var k = 0; k < fields.length; k++) {
                                        var cell = row.insertCell(k);
                                        if (fields[k].fieldname == "endtime" || fields[k].fieldname == "starttime") {
                                            cell.innerHTML = timestampToTime(dataarr[i][fields[k].fieldname]);
                                        } else if (fields[k].fieldname == "vid") {
                                            cell.innerHTML = dataarr[i]["vname"] ? dataarr[i]["vname"] : "暂无"
                                        } else if (fields[k].fieldname == "coach") {
                                            cell.innerHTML = dataarr[i]["coachname"] ? dataarr[i]["coachname"]+"-"+dataarr[i]["coachnickname"] : "暂无"
                                        } else if (fields[k].fieldname == "type") {
                                            for (var u of usercoursetype) {
                                                if (u[dataarr[i][fields[k].fieldname]]) {
                                                    cell.innerHTML = u[dataarr[i][fields[k].fieldname]];
                                                }
                                            }
                                        } else {
                                            cell.innerHTML = dataarr[i][fields[k].fieldname];
                                        }
                                    }
                                    var optcell = row.insertCell(fields.length);
                                    optcell.innerHTML = "<input type='image' src='../assets/img/bianji.png' id='bianji" + i + "' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='edit(" + data.courseannouncemap[i].id + "," + i + ")'>" +
                                        "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/shanchu.png' id='shanchu" + i + "' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='del(" + data.courseannouncemap[i].id + "," + i + ")'>";
                                }



							}
							maxpage = Math.ceil(data.respVo.resultDesc / count);
							//设置分页
							var first=$(".page>div>div:nth-child(1)");
							var prev=$(".page>div>div:nth-child(2)");
							var next=$(".page>div>div:nth-child(3)");
							var last=$(".page>div>div:nth-child(4)");
							if(page>1){
								first.attr("class","blue")
							}else{
								first.attr("class","gray")
							}
							if(page>1){
								prev.attr("class","blue")
							}else{
								prev.attr("class","gray")
							}
							if(page<maxpage){
								next.attr("class","blue")
							}else{
								next.attr("class","gray")
							}
							if(page<maxpage){
								last.attr("class","blue")
							}else{
								last.attr("class","gray")
							}
                        }else{
                            //alert(data.respVo.resultDesc);
                        }
					},
					error: function(err) {
//						alert("err:" + err);
					}
				});

			}
			//公共列表
			function initTables(idx){
                for (var i = 1; i < fields.length; i++) {
                    var row = user_table.insertRow(user_table.rows.length);
                    if(fields[i].fieldname=="vid" || fields[i].fieldname=="coach"){
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td style="padding-top: 18px">
							<select name="" id="${fields[i].fieldname}text" style="border-radius: 0px;width: 95%" onchange="check${fields[i].fieldname}text()"></select><br/>
							<span id="${fields[i].fieldname}text_info"></span>
							</td>`;
                    }else if(fields[i].fieldname=="type"){
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td style="padding-top: 18px">
							<select name="" id="${fields[i].fieldname}text" style="border-radius: 0px;width: 95%" onchange="check${fields[i].fieldname}text()"></select><br/>
							<span id="${fields[i].fieldname}text_info"></span>
							</td>`;
                        row.setAttribute("id","rowtype");
                    }else if(fields[i].fieldname=="starttime" || fields[i].fieldname=="endtime"){
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td style="padding-top: 18px">
							<input type="text" id="${fields[i].fieldname}text" class="timer" name="moduletitle" style="border-radius: 0px;width: 95%" value="${idx>=0?timestampToTime(dataarr[idx][fields[i].fieldname]):''}"
							  /><br />
							<span id="${fields[i].fieldname}text_info"></span>
							</td>`;
                        lay('.timer').each(function(){
                            laydate.render({
                                elem: this,
                                format: 'yyyy-MM-dd HH:mm' ,
                                btns: ['clear', 'confirm'],
                                trigger: 'click'
                            });
                        });
                    }else{
                        row.innerHTML=`<td class="tableleft"><span class="tanKuangSpan">${fields[i].name}</span></td><td style="padding-top: 18px">
							<input type="text" id="${fields[i].fieldname}text" class="txt" name="moduletitle" style="border-radius: 0px;width: 95%" value="${idx>=0?dataarr[idx][fields[i].fieldname]:fields[i].fieldname=="state"?'0':''}" /><br />
							<span id="${fields[i].fieldname}text_info"></span>
							</td>`;

                    }

                }
			}

            //新增用户
            function add1() {
                if(addable1 == 0){
                    return;
                }
                var s = document.getElementById("test");
                s.style.display = "block";
                var l = document.getElementById("user_div");
                l.style.display = "block";
                var user_table = document.getElementById('user_table');
                while (user_table.rows.length > 0) {
                    user_table.deleteRow(0);
                }
                currentIndex = -1;
                initTables(currentIndex);
                var select1 = document.getElementById("vidtext");
                while (select1.options.length > 0) {
                    select1.remove(0);
                }
                if(freevenue.length>0){
                    select1.options.add(new Option("请选择拳馆",""));
                    for (var i = 0; i < freevenue.length; i++) {
                        select1.options.add(new Option(freevenue[i].name,freevenue[i].id));
                    }
                }else{
                    select1.options.add(new Option("暂时没有空闲拳馆",""));
                }

                $("#vidtext").change(function(){
                    while (select2.options.length > 0) {
                        select2.remove(0);
                    }
                    var val=$(this).val();
                    select2.options.add(new Option("请选择教练",""));
                    for (var i = 0; i < allcoach.length; i++) {

                        if(val==allcoach[i].vid){
                            select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                        }else if(val==""){
                            select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                        }

                    }

                });

                var select2 = document.getElementById("coachtext");
                while (select2.options.length > 0) {
                    select2.remove(0);
                }
                if(allcoach.length>0){
                    select2.options.add(new Option("请选择教练",""));
                    for (var i = 0; i < allcoach.length; i++) {
                        select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                    }
                }else{
                    select2.options.add(new Option("暂时没有空闲教练",""));
                }
                var select3 = document.getElementById("typetext");
                while (select3.options.length > 0) {
                    select3.remove(0);
                }
                select3.options.add(new Option("大课",1));
                $("#rowtype").css("display","none");
                var optrow = user_table.insertRow(user_table.rows.length);
                optrow.innerHTML = `<tr>
					<td class="tableleft"></td>
					<td>
						<a  onclick="onSavebtnClickHandler()" class="save">保 存</a>
					</td>
				</tr>`;
            }


            function add2() {
                if(addable1 == 0){
                    return;
                }
                var s = document.getElementById("test");
                s.style.display = "block";
                var l = document.getElementById("user_div");
                l.style.display = "block";
                var user_table = document.getElementById('user_table');
                while (user_table.rows.length > 0) {
                    user_table.deleteRow(0);
                }
                currentIndex = -1;
                initTables(currentIndex);
                var select1 = document.getElementById("vidtext");
                while (select1.options.length > 0) {
                    select1.remove(0);
                }
                if(freevenue.length>0){
                    select1.options.add(new Option("请选择拳馆",""));
                    for (var i = 0; i < freevenue.length; i++) {
                        select1.options.add(new Option(freevenue[i].name,freevenue[i].id));
                    }
                }else{
                    select1.options.add(new Option("暂时没有空闲拳馆",""));
                }

                $("#vidtext").change(function(){
                    while (select2.options.length > 0) {
                        select2.remove(0);
                    }
                    var val=$(this).val();
                    select2.options.add(new Option("请选择教练",""));
                    for (var i = 0; i < allcoach.length; i++) {

                        if(val==allcoach[i].vid){
                            select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                        }else if(val==""){
                            select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                        }

                    }

                });

                var select2 = document.getElementById("coachtext");
                while (select2.options.length > 0) {
                    select2.remove(0);
                }
                if(allcoach.length>0){
                    select2.options.add(new Option("请选择教练",""));
                    for (var i = 0; i < allcoach.length; i++) {
                        select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                    }
                }else{
                    select2.options.add(new Option("暂时没有空闲教练",""));
                }
                var select3 = document.getElementById("typetext");
                while (select3.options.length > 0) {
                    select3.remove(0);
                }
                select3.options.add(new Option("企业",2));
                $("#rowtype").css("display","none");
                var optrow = user_table.insertRow(user_table.rows.length);
                optrow.innerHTML = `<tr>
					<td class="tableleft"></td>
					<td>
						<a  onclick="onSavebtnClickHandler()" class="save">保 存</a>
					</td>
				</tr>`;
            }

            //编辑用户
            function edit(id,idx) {

                if(updateable1 == 0){
                    return;
                }
                var s = document.getElementById("test");
                s.style.display = "block";
                var l = document.getElementById("user_div");
                l.style.display = "block";
                var user_table = document.getElementById('user_table');
                while (user_table.rows.length > 0) {
                    user_table.deleteRow(0);
                }
                currentIndex = idx;
                initTables(idx);
                var select1 = document.getElementById("vidtext");
                while (select1.options.length > 0) {
                    select1.remove(0);
                }

                if(parseInt(dataarr[idx].vid)!==0){
                    select1.options.add(new Option(dataarr[idx].vname,dataarr[idx].vid));
                }else{
                    select1.options.add(new Option("没指定拳馆",""));
                }

                for (var i = 0; i < freevenue.length; i++) {
                    if(parseInt(freevenue[i].id)!==parseInt(dataarr[idx].vid)){
						select1.options.add(new Option(freevenue[i].name, freevenue[i].id));
                    }
                }
                $("#vidtext").change(function(){
                    while (select2.options.length > 0) {
                        select2.remove(0);
                    }
                    var val=$(this).val();
                    select2.options.add(new Option("请选择教练",""));
                    for (var i = 0; i < allcoach.length; i++) {
                        if(val==allcoach[i].vid){
                            select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                        }else if(val==""){
                            select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                        }

                    }
                });
                var select2 = document.getElementById("coachtext");
                while (select2.options.length > 0) {
                    select2.remove(0);
                }
                if(parseInt(dataarr[idx].coach)!==0){
                    select2.options.add(new Option(dataarr[idx].coachname+"-"+dataarr[idx].coachnickname,dataarr[idx].coach));
                }else{
                    select2.options.add(new Option("没指定教练",""));
                }
                for (var i = 0; i < allcoach.length; i++) {
                    if(allcoach[i].id!==parseInt(dataarr[idx].coach) && select1.value==allcoach[i].vid){
                        select2.options.add(new Option(allcoach[i].name+"-"+allcoach[i].nickname,allcoach[i].id));
                    }
                }

                var select3 = document.getElementById("typetext");
                while (select3.options.length > 0) {
                    select3.remove(0);
                }
                if(dataarr[idx].type){
                    for (var u of usercoursetype) {
                        Object.keys(u).forEach(function(key) {
                            if (parseInt(key) == parseInt(dataarr[idx].type)) {
                                select3.options.add(new Option(u[key], dataarr[idx].type));
                            }
                        });
                    }
                }else{
                    select3.options.add(new Option("没指定类型",""));
                }

                for (var u of usercoursetype) {
                    Object.keys(u).forEach(function(key){
                        if(parseInt(key)!==parseInt(dataarr[idx].type)){
                            select3.options.add(new Option(u[key],key));
                        }
                    });
                }
                $("#rowtype").css("display","none");
                var optrow = user_table.insertRow(user_table.rows.length);
                optrow.innerHTML = `<tr>
										<td class="tableleft"></td>
										<td colspan="3">
											<a  onclick="onSavebtnClickHandler(${id})" class="save">保 存</a>
										</td>
									</tr>`;
            }



            //删除用户
			function del(id,idx) {
				if (confirm("确定要删除吗？")) {
				    var obj=new Object();
				    obj.index=id;
                    var datajson=JSON.stringify(obj);
                   // console.log(datajson);
					$.ajax({
                        type: "post",
                        contentType:"application/x-www-form-urlencoded",
                        dataType:"json",
                        data:datajson,
                        url:"http://" + url1 + ":6078/backstagedelcourseannounce",
						success: function(data) {
                            //console.log(data);
                            dataarr[idx].state=-1;
                            if (window.sessionStorage) {
                                updateCourseannounce = JSON.parse(sessionStorage.getItem("updateCourseannounce")?sessionStorage.getItem("updateCourseannounce"):"[]");
                                if(updateCourseannounce.length>0) {
                                    var len=0;
                                    for (var j = 0; j < updateCourseannounce.length; j++) {
                                        if (dataarr[idx].id == updateCourseannounce[j].id) {
                                            len++;
                                             updateCourseannounce[j]=dataarr[idx];
                                        }
                                    }
                                    if(len==0){
                                        updateCourseannounce.push(dataarr[idx]);
                                    }
                                    sessionStorage.setItem("updateCourseannounce", JSON.stringify(updateCourseannounce));
                                }else{
                                    updateCourseannounce.push(dataarr[idx]);
                                    sessionStorage.setItem("updateCourseannounce", JSON.stringify(updateCourseannounce));
								}
                            } else {
                                updateCourseannounce = JSON.parse(Cookie.read("updateCourseannounce")?Cookie.read("updateCourseannounce"):"[]");
                                if(updateCourseannounce.length>0) {
                                    var len=0;
                                    for (var j = 0; j < updateCourseannounce.length; j++) {
                                        if (dataarr[idx].id == updateCourseannounce[j].id) {
                                            len++;
                                            updateCourseannounce[j]=dataarr[idx];
                                        }
                                    }
                                    if(len==0){
                                        updateCourseannounce.push(dataarr[idx]);
                                    }
                                    Cookie.write("updateCourseannounce", JSON.stringify(updateCourseannounce));
                                }else{
                                    updateCourseannounce.push(dataarr[idx]);
                                    Cookie.write("updateCourseannounce", JSON.stringify(updateCourseannounce));
								}
                            }
							init();
						},
						error: function(err) {
                            //mizhu.alert('','err:'+ err,'iconfont-close');
						}
					});
				}
			}


			//保存添加与修改的用户
			function onSavebtnClickHandler(id,requrl = "") {
                if(checknametext()&&checkdescriptiontext()&&checkvidtext()&&checkcoachtext()&&checkstarttime()&&checkendtime()&&checktypetext()){
                    var datajson;
                    if (requrl == undefined || requrl.length == 0) {
                        if (currentIndex >= 0) {
                                var url = "http://" + url1 + ":6078/backstageupdatecourseannounce";
								var obj = new Object();
								obj.id = parseInt(id);
								for (var i = 1; i < fields.length; i++) {
									if(fields[i].fieldname=="starttime" || fields[i].fieldname=="endtime"){
										var data=new Date(document.getElementById(fields[i].fieldname + 'text').value);
										obj[fields[i].fieldname] = data.getTime();
									}else{
										obj[fields[i].fieldname] = document.getElementById(fields[i].fieldname + 'text').value;
									}

								}
                                datajson = JSON.stringify(obj);
                               // console.log(datajson);
                                save();

                        } else {

                                var url = "http://" + url1 + ":6078/backstageaddcourseannounce";
                                var obj = new Object();
								for (var i = 1; i < fields.length; i++) {
									if(fields[i].fieldname=="starttime" || fields[i].fieldname=="endtime"){
										var data=new Date(document.getElementById(fields[i].fieldname + 'text').value);
										obj[fields[i].fieldname] = data.getTime();
									}else{
										obj[fields[i].fieldname] = document.getElementById(fields[i].fieldname + 'text').value;
									}
								}
                                datajson = JSON.stringify(obj);
                                //console.log(datajson);
                                save();


                        }
                        function save(){
                            $.ajax({
                                type: "post",
                                contentType: "application/x-www-form-urlencoded",
                                data: datajson,
                                dataType: "json",
                                url: url,
                                success: function (data) {
                                    // console.log(data);
                                    //console.log(currentIndex);
                                    if (currentIndex >= 0) {
                                        if(data.respVo.resultCode<0){
                                            mizhu.alert('',data.respVo.resultDesc,'iconfont-close');
                                            return;
                                        }else{
                                            datajson=JSON.parse(datajson);
                                            datajson.coachname=$("#coachtext option:selected").text().split("-")[0];
                                            datajson.coachnickname=$("#coachtext option:selected").text().split("-")[1];
                                            datajson.vname=$("#vidtext option:selected").text();
                                            if (window.sessionStorage) {
                                                updateCourseannounce = JSON.parse(sessionStorage.getItem("updateCourseannounce")?sessionStorage.getItem("updateCourseannounce"):"[]");
                                                if(updateCourseannounce.length>0) {
                                                    var len=0;
                                                    for (var j = 0; j < updateCourseannounce.length; j++) {
                                                        //console.log(updateCourseannounce[j].id+"b");
                                                        if (datajson.id == updateCourseannounce[j].id) {
                                                             len++;
                                                             updateCourseannounce[j]=datajson;
                                                        }
                                                    }
                                                    if(len==0){
                                                        updateCourseannounce.push(datajson);
													}
                                                    sessionStorage.setItem("updateCourseannounce", JSON.stringify(updateCourseannounce));
                                                }else{
                                                    updateCourseannounce.push(datajson);
                                                    sessionStorage.setItem("updateCourseannounce", JSON.stringify(updateCourseannounce));
                                                }
                                            } else {
                                                updateCourseannounce = JSON.parse(Cookie.read("updateCourseannounce")?Cookie.read("updateCourseannounce"):"[]");
                                                if(updateCourseannounce.length>0) {
                                                    var len=0;
                                                    for (var j = 0; j < updateCourseannounce.length; j++) {
                                                        if (datajson.id == updateCourseannounce[j].id) {
                                                            len++;
                                                             updateCourseannounce[j]=datajson;
                                                        }
                                                    }
                                                    if(len==0){
                                                        updateCourseannounce.push(datajson);
                                                    }
                                                    Cookie.write("updateCourseannounce", JSON.stringify(updateCourseannounce));
                                                }else{
                                                    updateCourseannounce.push(datajson);
                                                    Cookie.write("updateCourseannounce", JSON.stringify(updateCourseannounce));
                                                }
                                            }
                                            mizhu.alert('', '修改成功','iconfont-gou');
                                            init();
                                            cancel_shield();
                                        }
                                    }
                                    else {
                                        if(data.respVo.resultCode<0){
                                            mizhu.alert('',data.respVo.resultDesc,'iconfont-close');
                                            return;
										}else{
                                            mizhu.alert('', '添加成功','iconfont-gou');
                                            init();
                                            cancel_shield();
										}

                                    }
                                },
                                error: function (err) {
                                    //mizhu.alert('','保存失败','iconfont-close');
                                    cancel_shield();
                                }
                            });
						}

                    }
                }else{
                    mizhu.alert('', '请正确完善信息','iconfont-close');
                }

			}

            //验证
            function checknametext(){
                var nametext = document.getElementById("nametext");
                var nametext_info = document.getElementById("nametext_info");
                if (nametext.value == "" ) {
                    nametext_info.innerHTML = "该字段不能为空";
                    nametext.style.border = "1px solid red";
                    nametext_info.style.color = "red";
                    return false;
                }
                else {
                    nametext_info.innerHTML = "";
                    nametext.style.border = "";
                    return true;
                }

            }

            function checkdescriptiontext(){
                var descriptiontext = document.getElementById("descriptiontext");
                var descriptiontext_info = document.getElementById("descriptiontext_info");
                if (descriptiontext.value == "" ) {
                    descriptiontext_info.innerHTML = "该字段不能为空";
                    descriptiontext.style.border = "1px solid red";
                    descriptiontext_info.style.color = "red";
                    return false;
                }
                else {
                    descriptiontext_info.innerHTML = "";
                    descriptiontext.style.border = "";
                    return true;
                }

            }

            function checkvidtext(){
                var vidtext = document.getElementById("vidtext");
                var vidtext_info = document.getElementById("vidtext_info");
                if (vidtext.value == "" ) {
                    vidtext_info.innerHTML = "请选择所属拳馆";
                    vidtext.style.border = "1px solid red";
                    vidtext_info.style.color = "red";
                    return false;
                }
                else {
                    vidtext_info.innerHTML = "";
                    vidtext.style.border = "";
                    return true;

                }

            }


            function checkcoachtext(){
                var coachtext = document.getElementById("coachtext");
                var coachtext_info = document.getElementById("coachtext_info");
                if (coachtext.value == "") {
                    coachtext_info.innerHTML = "该字段不能为空";
                    coachtext.style.border = "1px solid red";
                    coachtext_info.style.color = "red";
                    return false;
                }
                else {
                    //console.log(coursecoach);

					coachtext_info.innerHTML = "";
					coachtext.style.border = "";
					return true;


                }

            }


            //开始时间
            function checkstarttime() {
                var starttimetext = document.getElementById("starttimetext");
                var starttimetext_info = document.getElementById("starttimetext_info");
                if (starttimetext.value == "" ) {
                    starttimetext_info.innerHTML = "该字段不能为空";
                    starttimetext.style.border = "1px solid red";
                    starttimetext_info.style.color = "red";
                    return false;
                }
                else {
                    starttimetext_info.innerHTML = "";
                    starttimetext.style.border = "";
                    return true;

                }

            }
            //结束时间
            function checkendtime() {
                var starttimetext = document.getElementById("starttimetext");
                var endtimetext = document.getElementById("endtimetext");
                var endtimetext_info = document.getElementById("endtimetext_info");
                var startime=new Date(starttimetext.value).getTime();
                var endtime=new Date(endtimetext.value).getTime();

                if (endtimetext.value == "" ) {
                    endtimetext_info.innerHTML = "该字段不能为空";
                    endtimetext.style.border = "1px solid red";
                    endtimetext_info.style.color = "red";
                    return false;
                }
                else {
                    if(endtime<startime){
                        endtimetext_info.innerHTML = "请选择不小于开始日期的结束日期";
                        endtimetext.style.border = "1px solid red";
                        endtimetext_info.style.color = "red";
                        return false;
                    }else{
                        endtimetext_info.innerHTML = "";
                        endtimetext.style.border = "";
                        return true;
                    }

                }
            }

            function checktypetext(){
                var typetext = document.getElementById("typetext");
                var typetext_info = document.getElementById("typetext_info");
                if (typetext.value == "" ) {
                    typetext_info.innerHTML = "该字段不能为空";
                    typetext.style.border = "1px solid red";
                    typetext_info.style.color = "red";
                    return false;
                }
                else {
					typetext_info.innerHTML = "";
					typetext.style.border = "";
					return true;
                }

            }


			//关闭弹出的div
			function cancel_shield() {
				var s = document.getElementById("test");
				s.style.display = "none";
                var e = document.getElementById("user_div");
                e.style.display = "none";
				var m = document.getElementById("mytooltip");
				m.style.display = "none";
			}


            //转换时间戳
            function timestampToTime(timestamp) {
                var date = new Date(timestamp);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
                Y = date.getFullYear() + '-';
                M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
                D = date.getDate()<10 ? '0'+date.getDate()+ ' ':date.getDate() + ' ';
                h = date.getHours()<10 ? '0'+date.getHours()+ ':':date.getHours() + ':';
                m = date.getMinutes()<10 ? '0'+date.getMinutes():date.getMinutes();
                s = date.getSeconds();
                return Y+M+D+h+m;
            }

			//查询
			function inquiry() {
				page = 1;
				document.getElementById('pagelab').value = page;
				if (window.sessionStorage) {
					sessionStorage.setItem("Node_page", page);
				} else {
					Cookie.write("Node_page", page);
				}
				$.ajax({
					type: "get",
					contentType: "application/xml",
					url: "http://" + localhost + ":8080/fkds1.5.tools/systemManager/getManagerByName.action?name=" + document.getElementById('rolename').value + "&page=1&count=10",
					success: function(data) {
						res = jQuery.parseJSON(data);
						var table1 = document.getElementById('tbl');
						while (table1.rows.length > 1) {
							table1.deleteRow(1);
						}
						dataarr = [];
						for (var i = 0; i < res.res.length; i++) {
							dataarr.push(res.res[i]);
							var row = table1.insertRow(table1.rows.length);
							for (var k = 0; k < fields.length; k++) {
								var cell = row.insertCell(k);
								cell.innerHTML = res.res[i][fields[k].fieldname];
							}
							var optcell = row.insertCell(fields.length);
							optcell.innerHTML = "<input type='image' src='../assets/img/bianji.png' id='bianji"+i+"' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='edit(" + i + ")'>" +
								"&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/shanchu.png' id='shanchu"+i+"' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='del(" + res.res[i].id + "," + table1.rows.length + ")'>";
							if (dataarr[i].state ==-1) {
								optcell.innerHTML ="<input type='image' src='../assets/img/bianji.png' id='bianji"+i+"' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='edit(" + res.res[i].id + "," + i + ")'>";
							}
						}
					},
					error: function(err) {
//						alert("err:" + err);
					}
				});
			}

            //分页
			function first(){
				if(document.getElementById("pagelab").value==1){
                    mizhu.alert('','当前已经为第一页!','iconfont-close');
				}
				else{
					initTable(1,true);
				}

			}
			function last(){

				if(document.getElementById("pagelab").value==maxpage){
                    mizhu.alert('','当前已经为最后页!','iconfont-close');
				}
				else{
					initTable(parseInt(maxpage),true);
				}

			}

			function initTable(step, flag = false) {
				initFields();
				step = parseInt(step);
				var p = parseInt(page) + parseInt(step);
				if (flag) {
					if (step < 1 || step > maxpage) {
                        mizhu.alert('','页码超标','iconfont-close');
						return;
					}
					page = step;
				} else {
					page = p;
					if (page < 1 || page > maxpage) {
						page -= step;
						return;
					}
				}

                var obj=new Object();
                obj.vid=manager.vid;
                obj.page=page;
                obj.count=count;
                var datajson=JSON.stringify(obj);
                $.ajax({
                    type: "post",
                    contentType:"application/x-www-form-urlencoded",
                    data:datajson,
                    dataType:"json",
                    url:"http://" + url1 + ":6078/backstagegetcourseannounce",
                    success: function(data) {
                        var table1 = document.getElementById('tbl');
                        dataarr = [];
                        while (table1.rows.length > 1) {
                            table1.deleteRow(1);
                        }
                        //设置排序
                        data.courseannouncemap.sort(function sortId(a,b){
                            return b.id-a.id
                        });
                        //console.log(data.courseannouncemap);
                        if (window.sessionStorage ) {
                            updateCourseannounce = JSON.parse(sessionStorage.getItem("updateCourseannounce")?sessionStorage.getItem("updateCourseannounce"):"[]");
                        } else {
                            updateCourseannounce = JSON.parse(Cookie.read("updateCourseannounce")?sessionStorage.getItem("updateCourseannounce"):"[]");
                        }
                        //console.log(updateCourseannounce);
                        for (var i = 0; i < data.courseannouncemap.length; i++) {
                            if(updateCourseannounce.length>0) {
                                for (var j = 0; j < updateCourseannounce.length; j++) {
                                    if (data.courseannouncemap[i].id == updateCourseannounce[j].id) {
                                        data.courseannouncemap[i] = updateCourseannounce[j];
                                    }
                                }
                            }
                            dataarr.push(data.courseannouncemap[i]);
                            if(data.courseannouncemap[i].state!==-1) {
                                var row = table1.insertRow(table1.rows.length);
                                for (var k = 0; k < fields.length; k++) {
                                    var cell = row.insertCell(k);
                                    if (fields[k].fieldname == "endtime" || fields[k].fieldname == "starttime") {
                                        cell.innerHTML = timestampToTime(dataarr[i][fields[k].fieldname]);
                                    } else if (fields[k].fieldname == "vid") {
                                        cell.innerHTML = dataarr[i]["vname"] ? dataarr[i]["vname"] : "暂无"
                                    } else if (fields[k].fieldname == "coach") {
                                        cell.innerHTML = dataarr[i]["coachname"] ? dataarr[i]["coachname"]+"-"+dataarr[i]["coachnickname"] : "暂无"
                                    } else if (fields[k].fieldname == "type") {
                                        for (var u of usercoursetype) {
                                            if (u[dataarr[i][fields[k].fieldname]]) {
                                                cell.innerHTML = u[dataarr[i][fields[k].fieldname]];
                                            }
                                        }
                                    } else {
                                        cell.innerHTML = dataarr[i][fields[k].fieldname];
                                    }
                                }
                                var optcell = row.insertCell(fields.length);
                                optcell.innerHTML = "<input type='image' src='../assets/img/bianji.png' id='bianji" + i + "' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='edit(" + data.courseannouncemap[i].id + "," + i + ")'>" +
                                    "&nbsp;&nbsp;&nbsp;<input type='image' src='../assets/img/shanchu.png' id='shanchu" + i + "' onmousemove='isdisadd(this)' onmouseout='isdisout(this)' value='' onclick='del(" + data.courseannouncemap[i].id + "," + i + ")'>";
                            }



                        }
                        maxpage = Math.ceil(data.respVo.resultDesc / count);
                        document.getElementById('pagelab').value = page;
                    },
                    error: function(err) {
//						alert("err:" + err);
                    }
                });
			}

			function pageKeyUpHandler(evt) {
				if (evt.keyCode == 13) {
					initTable(parseInt(document.getElementById("pagelab").value), true);
				}
			}


			//权限增删改
	        function isdisadd(obj) {

	            var idstr = obj.id;

	            if (addable1 == 0 && idstr.indexOf("add")>=0){
	                document.getElementById(idstr).disabled = 'disabled';
	                document.getElementById(idstr).style.cursor = "not-allowed";
	            }
	
	            if (updateable1 == 0 && idstr.indexOf("bian")>=0){
	                document.getElementById(idstr).disabled = 'disabled';
	                document.getElementById(idstr).style.cursor = "not-allowed";
	            }
	
	            if (delable1 == 0 && idstr.indexOf("shan")>=0){
	                document.getElementById(idstr).disabled = 'disabled';
	                document.getElementById(idstr).style.cursor = "not-allowed";
	            }
	        }
	
	        function isdisout(obj) {
	            var idstr = obj.id;
	            document.getElementById(idstr).disabled = false;
	            document.getElementById(idstr).style.cursor = "pointer";
	        }

		</script>
</head>
	<body onload="init()">
		<div class="onclick">
			<a id="addnew1"  onclick="add1()" class="add2">大 课 新  增</a>&nbsp;&nbsp;&nbsp;&nbsp;
			<a id="addnew2"  onclick="add2()" class="add2">企业课新增</a>
		</div>
		<!--<a  id="qingkong" onclick="qingkong()"><image style="margin-top: 10px" src="../assets/img/xinzeng.png"></image></a>-->
		<table class="table table-hover definewidth m10" id="tbl">
			<thead id="thead">
				<tr id="tabhead" class="theadColor">
				</tr>
			</thead>
		</table>

		<div class="inline pull-right page">
			<div class="first" onclick="first()">第一页</div>
			<div class="prev" onclick="initTable(-1)">上一页</div>
			<div class="next" onclick="initTable(1)">下一页</div>
			<div class="last" onclick="last()">最后一页</div>
			<div class="clearfix"></div>
			<input type="hidden" id="pagelab" style="width: 50px;height:22px;overflow:hidden;margin-right: 5px;text-align: center;border-radius: 0px" onkeyup="pageKeyUpHandler(event)">
		</div>

		<!--//弹出遮罩-->
		<div id="test"></div>

		<!--会员新增与编辑-->
		<div id="user_div">
			<input type="image" src='../assets/img/guanbi.png' onclick="cancel_shield()" style="position: absolute;left: 745px;top: 10px;width: 27px;height: 27px">
			<table class="table table-bordered " style="width: 600px;margin:0 auto;margin-top: 60px" id="user_table">
			</table>
		</div>

		<div id="mytooltip"></div>

		<div id="test1"><span>数据同步中，请稍后......</span></div>
	</body>

</html>